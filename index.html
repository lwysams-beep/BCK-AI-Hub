<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hub | V5.0 ç®¡ç†èˆ‡è¨ªå®¢ç‰ˆ</title>
    
    <link rel="icon" href="https://img.icons8.com/fluency/96/artificial-intelligence.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        /* æ ¸å¿ƒæ¨£å¼ (åŸºæ–¼ V3.5) */
        :root {
            --primary: #2c3e50;
            --accent: #00d2ff;
            --accent-dark: #3a7bd5;
            --light: #ecf0f1;
            --success: #00b09b;
            --warning: #f39c12;
            --danger: #e74c3c;
            --admin-color: #8e44ad;
            --value-edu-color: #e91e63;
            --terminal-bg: #1e1e1e;
            --terminal-text: #00ff00;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f4f7f6; display: flex; height: 100vh; overflow-x: hidden; }
        
        /* æ¼¸è®Šå´é‚Šæ¬„ */
        .sidebar { width: 260px; background: linear-gradient(135deg, #141e30 0%, #243b55 100%); color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 1001; flex-shrink: 0; white-space: nowrap; transition: all 0.3s; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; width: 100%; transition: margin 0.3s; }
        
        /* æ‰‹æ©Ÿé©é… */
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .header-bar { display: flex; align-items: center; margin-bottom: 20px; }
        .menu-toggle-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--primary); padding: 5px 15px 5px 0; outline: none; }
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); width: 260px; }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .main-content { padding: 15px; }
            .charts-row, .leaderboard-section { grid-template-columns: 1fr !important; }
        }

        /* å´é‚Šæ¬„å…ƒç´  */
        .sidebar-header { text-align: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; }
        .school-name { font-size: 0.85rem; opacity: 0.8; letter-spacing: 0.5px; margin-bottom: 5px; font-weight: 500;}
        .app-name { font-size: 1.4rem; margin: 0; font-weight: bold; background: -webkit-linear-gradient(#00d2ff, #3a7bd5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .version-tag { font-size: 0.7rem; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; margin-top: 5px; display: inline-block; color: #bdc3c7; }
        
        .menu-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; border: 1px solid transparent; }
        .menu-item:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
        .menu-item.active { background: rgba(255,255,255,0.15); border-left: 4px solid var(--accent); }
        .menu-icon { margin-right: 10px; width: 20px; text-align: center; }
        .user-info { margin-top: auto; padding-top:20px; border-top:1px solid rgba(255,255,255,0.2); font-size: 0.9rem; }

        /* å…¬å‘Šæ¬„æ¨£å¼ (V5.0 æ–°å¢) */
        .announcement-box { 
            background: #fff3cd; 
            border: 1px solid #ffeeba; 
            color: #856404; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            animation: fadeIn 0.5s;
        }

        /* å„€è¡¨æ¿ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid var(--accent-dark); }
        .stat-number { font-size: 2.5rem; font-weight: 800; color: var(--primary); margin: 10px 0; }
        
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-height: 400px; display:flex; flex-direction:column; }
        canvas { flex: 1; max-height: 320px; width: 100%; }

        /* æ’è¡Œæ¦œ (V5.0 æ–°å¢å„ªè³ªæ¦œ) */
        .leaderboard-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .leaderboard-box { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .leaderboard-table th { text-align: left; padding: 10px; color: #7f8c8d; font-size: 0.9rem; border-bottom: 2px solid #eee; }
        .leaderboard-table td { padding: 12px 10px; border-bottom: 1px solid #f5f5f5; font-size: 0.95rem; }
        .rank-badge { width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; background: #eee; color: #555; margin-right: 5px; }
        .rank-1 { background: #ffd700; color: #d35400; }
        .rank-2 { background: #C0C0C0; color: #555; }
        .rank-3 { background: #cd7f32; color: #fff; }

        /* è³‡æºå¡ç‰‡ */
        .resource-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.2s; overflow: hidden; display: flex; flex-direction: column; border: 1px solid #eee; cursor: pointer; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.1); border-color: var(--accent); }
        .card-preview-area { width: 100%; height: 160px; position: relative; overflow: hidden; background: #f0f0f0; border-bottom: 1px solid #eee; }
        .card-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .card-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .ph-icon { font-size: 3.5rem; margin-bottom: 5px; opacity: 0.9; }
        .card-content { padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .card-title { margin: 0 0 5px 0; font-size: 1.15rem; color: #2c3e50; font-weight: 700; }
        .card-meta { font-size: 0.8rem; color: #95a5a6; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .tag-row { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 5px; }
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; background: #eee; color: #555; }
        .tag-5c { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .card-desc { font-size: 0.9rem; color: #555; flex: 1; margin-bottom: 10px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

        /* Prompts (é»‘åº•ç¶ å­—) */
        .prompt-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .prompt-content-box { background: var(--terminal-bg); color: var(--terminal-text); padding: 15px; font-family: 'Courier New', monospace; font-size: 0.95rem; border-radius: 6px; margin-bottom: 15px; border: 1px solid #333; white-space: pre-wrap; max-height: 250px; overflow-y: auto; }

        /* é€šç”¨å…ƒä»¶ */
        .page { display: none; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #3a7bd5, #00d2ff); color: white; }
        .btn-success { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
        .btn-admin { background-color: var(--admin-color); color: white; }
        .btn-value { background-color: var(--value-edu-color); color: white; }
        .btn-outline { border: 1px solid #ccc; background: white; color: #555; }
        .btn-xs { padding: 4px 8px; font-size: 0.8rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        .form-group { margin-bottom: 18px; }

        /* è©³æƒ…è¦–çª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-container { background: white; width: 90%; max-width: 900px; height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; animation: slideUp 0.3s; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; display: grid; grid-template-columns: 3fr 2fr; gap: 30px; }
        @media(max-width:768px){ .modal-body { grid-template-columns: 1fr; } }
        
        .rating-section { background: #f9f9f9; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .star-input span { cursor: pointer; font-size: 1.5rem; color: #ccc; transition: 0.2s; }
        .star-input span.active { color: #f39c12; }
        .guest-lock { opacity: 0.5; pointer-events: none; position: relative; } /* è¨ªå®¢é–å®šæ¨£å¼ */

        #loginModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(20, 30, 48, 0.95); display: flex; justify-content: center; align-items: center; z-index: 3000; }
    </style>
</head>
<body>

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="loginModal">
        <div style="background:white; padding:40px; border-radius:15px; width:340px; text-align:center;">
            <h2 style="color:var(--primary); margin-top:0;">BCK-AI Hub V5.0</h2>
            <p style="color:#7f8c8d; margin-bottom:20px;">æ ¡æ–¹å¸³è™Ÿæˆ–è¨ªå®¢ç™»å…¥</p>
            <input type="email" id="loginEmail" class="form-control" placeholder="Email (è€å¸«å°ˆç”¨)">
            <input type="password" id="loginPass" class="form-control" placeholder="Password / è¨ªå®¢å¯†ç¢¼ (26754411!)">
            <button id="loginBtn" class="btn btn-primary" style="width:100%" onclick="handleLogin()">ç™»å…¥ç³»çµ±</button>
            <p id="loginMsg" style="color:red; font-size:0.9rem; margin-top:10px; min-height:20px;"></p>
        </div>
    </div>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar">
        <div class="sidebar-header">
            <div class="school-name">é¦™æµ·æ­£è¦ºè“®ç¤¾<br>ä½›æ•™æ­£è¦ºè“®ç¤¾å­¸æ ¡</div>
            <h2 class="app-name">BCK-AI Hub</h2>
            <div class="version-tag">V5.0 Admin+Guest</div>
        </div>
        <div id="menu-dashboard" class="menu-item active" onclick="showPage('dashboard')"><span class="menu-icon">ğŸ“Š</span> æ•¸æ“šç¸½è¦½</div>
        <div id="menu-apps" class="menu-item" onclick="showPage('apps')"><span class="menu-icon">ğŸ“±</span> è³‡æºå±•ç¤ºåº«</div>
        <div id="menu-prompts" class="menu-item" onclick="showPage('prompts')"><span class="menu-icon">ğŸ’¡</span> å¥½Prompt åˆ†äº«</div>
        <div id="menu-upload" class="menu-item" onclick="showPage('upload')"><span class="menu-icon">ğŸ“¤</span> ä¸Šè¼‰åˆ†äº«</div>
        <div class="user-info">
            <p>ğŸ‘‹ <span id="currentUserDisplay">...</span></p>
            <button class="btn btn-outline btn-xs" style="width:100%; border-color:rgba(255,255,255,0.3); color:white; background:transparent;" onclick="logout()">ç™»å‡º</button>
        </div>
    </div>

    <div class="main-content">
        <div class="header-bar">
            <button class="menu-toggle-btn" onclick="toggleSidebar()">â˜°</button>
            <h2 style="margin:0; color:var(--primary);">BCK-AI Hub</h2>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard" class="page active">
            <h1 style="margin-bottom:20px;">å¹³å°æ•¸æ“šå„€è¡¨æ¿</h1>
            
            <!-- V5.0 å…¬å‘Šæ¬„ -->
            <div id="announcementContainer" style="display:none;">
                <div class="announcement-box">
                    <div>
                        <strong>ğŸ“¢ ç³»çµ±å…¬å‘Šï¼š</strong> <span id="announcementText">è¼‰å…¥ä¸­...</span>
                    </div>
                    <button id="editAnnouncementBtn" class="btn btn-xs btn-outline" style="background:white; display:none;" onclick="editAnnouncement()">âœï¸ ç·¨è¼¯</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card" style="border-bottom-color: var(--accent-dark);"><div class="stat-number" id="totalApps">0</div><div>å­¸æ•™è©•è³‡æº</div></div>
                <div class="stat-card" style="border-bottom-color: var(--admin-color);"><div class="stat-number" id="totalAdmin">0</div><div>è¡Œæ”¿è³‡æº</div></div>
                <div class="stat-card" style="border-bottom-color: var(--warning);"><div class="stat-number" id="totalPrompts">0</div><div>Prompt æŒ‡ä»¤</div></div>
                <div class="stat-card" style="border-bottom-color: var(--success);"><div class="stat-number" id="activeTeachers">0</div><div>åƒèˆ‡è€å¸«</div></div>
            </div>

            <div class="charts-row">
                <div class="chart-box">
                    <h3 style="color:var(--accent-dark); margin-top:0;">ğŸ“ å­¸ç§‘åˆ†ä½ˆ</h3>
                    <div style="flex:1; position:relative"><canvas id="subjectChart"></canvas></div>
                </div>
                <div class="chart-box">
                    <h3 style="color:var(--admin-color); margin-top:0;">ğŸ“‚ è¡Œæ”¿åˆ†é¡</h3>
                    <div style="flex:1; position:relative"><canvas id="adminChart"></canvas></div>
                </div>
            </div>
            <div class="chart-box" style="margin-bottom:20px;">
                <h3 style="color:#2ecc71; margin-top:0;">ğŸŒŸ 5C+ ç´ é¤Šåˆ†ä½ˆ</h3>
                <div style="flex:1; max-height:300px;"><canvas id="fiveCChart"></canvas></div>
            </div>

            <!-- V5.0 é›™æ’è¡Œæ¦œ -->
            <div class="leaderboard-section">
                <div class="leaderboard-box">
                    <h3 style="margin-top:0; color:#d35400;">ğŸ† æ´»èºè²¢ç»æ’è¡Œæ¦œ</h3>
                    <table class="leaderboard-table" id="contributorTable">
                        <thead><tr><th>æ’å</th><th>è€å¸«</th><th>è²¢ç»æ•¸</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="leaderboard-box">
                    <h3 style="margin-top:0; color:#f1c40f;">â­ å„ªè³ªä½œå“æ’è¡Œæ¦œ (Top Rated)</h3>
                    <table class="leaderboard-table" id="topRatedTable">
                        <thead><tr><th>æ’å</th><th>ä½œå“åç¨±</th><th>è©•åˆ†</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- APPS PAGE -->
        <div id="apps" class="page">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h1>è³‡æºå±•ç¤ºåº«</h1>
                <div>
                    <button class="btn btn-all" onclick="filterApps('all')">å…¨éƒ¨</button>
                    <button class="btn btn-primary" onclick="filterApps('teaching')">å­¸æ•™è©•</button>
                    <button class="btn btn-value" onclick="filterApps('value')">ğŸ’— åƒ¹å€¼è§€</button>
                    <button class="btn btn-admin" onclick="filterApps('admin')">è¡Œæ”¿</button>
                </div>
            </div>
            <div id="appsContainer" class="resource-grid"></div>
        </div>

        <!-- PROMPTS PAGE -->
        <div id="prompts" class="page">
            <h1>å¥½ Prompt åˆ†äº«å€</h1>
            <div id="promptsContainer" class="resource-grid" style="grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));"></div>
        </div>

        <!-- UPLOAD PAGE -->
        <div id="upload" class="page">
            <h1>ä¸Šè¼‰ / ç·¨è¼¯è³‡æº</h1>
            <div style="background:white; padding:30px; border-radius:12px; max-width:800px; margin:0 auto;">
                <!-- è¨ªå®¢è­¦å‘Š -->
                <div id="guestUploadMsg" style="display:none; background:#ffebee; color:#c0392b; padding:15px; border-radius:8px; text-align:center; font-weight:bold; margin-bottom:20px;">âš ï¸ è¨ªå®¢æ¨¡å¼ï¼šæ‚¨æ²’æœ‰æ¬Šé™ä¸Šè¼‰æˆ–ä¿®æ”¹è³‡æºã€‚</div>

                <div id="uploadFormContent">
                    <input type="hidden" id="editModeId" value="">
                    <div class="form-group"><label>è³‡æºé¡å‹</label><select id="uploadType" class="form-control" onchange="toggleUploadForm()"><option value="app">ä¸Šè¼‰ä½œå“</option><option value="prompt">ç´”åˆ†äº« AI Prompt</option></select></div>
                    
                    <div id="appForm">
                        <div class="form-group"><label>ä½œå“åç¨±</label><input type="text" id="appTitle" class="form-control"></div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                            <div class="form-group"><label>åˆ†é¡</label><select id="appCategory" class="form-control" onchange="handleCatChange()"><option value="teaching">å­¸æ•™è©•</option><option value="admin">è¡Œæ”¿</option></select></div>
                            <div class="form-group" id="subjGroup"><label>ç§‘ç›®</label><select id="appSubject" class="form-control" onchange="handleSubjChange()"><option>ä¸­æ–‡</option><option>è‹±æ–‡</option><option>æ•¸å­¸</option><option>å¸¸è­˜/ç§‘å­¸</option><option>äººæ–‡</option><option>è¦–è—</option><option>éŸ³æ¨‚</option><option>é«”è‚²</option><option>åœ–æ›¸</option><option>æ™®é€šè©±</option><option>ä½›å­¸</option><option>ç§‘æŠ€</option><option>åƒ¹å€¼è§€æ•™è‚²</option><option>è·¨èª²ç¨‹</option></select><div id="crossSubSection" style="display:none; margin-top:5px;"><div id="crossSubChecks" class="checkbox-grid"></div></div></div>
                            <div class="form-group" id="admGroup" style="display:none;"><label>è¡Œæ”¿é¡åˆ¥</label><select id="appAdminType" class="form-control"><option>æ ¡å‹™é‹ä½œ</option><option>æ–‡æ›¸è™•ç†</option><option>æ•¸æ“šåˆ†æ</option><option>è³‡è¨Šé€šè¨Š</option><option>æ´»å‹•ç­–åŠƒ</option><option>è³‡æºç®¡ç†</option></select></div>
                        </div>
                        
                        <div class="form-group" id="5cGroup">
                            <label>ğŸŒŸ 5C+ æ ¸å¿ƒç´ é¤Š</label>
                            <div class="checkbox-grid">
                                <label><input type="checkbox" name="5c" value="Creativity"> Creativity</label>
                                <label><input type="checkbox" name="5c" value="Critical Thinking"> Critical Thinking</label>
                                <label><input type="checkbox" name="5c" value="Communication"> Communication</label>
                                <label><input type="checkbox" name="5c" value="Collaboration"> Collaboration</label>
                                <label><input type="checkbox" name="5c" value="Contribution"> Contribution</label>
                            </div>
                        </div>

                        <div class="form-group"><label>æª”æ¡ˆé¡å‹</label><select id="resourceType" class="form-control" onchange="handleResType()"><option value="url">ç¶²é é€£çµ</option><option value="image">åœ–ç‰‡</option><option value="video">å½±ç‰‡</option><option value="presentation">ç°¡å ±</option><option value="worksheet">å·¥ä½œç´™</option></select></div>
                        <div class="form-group" id="urlGroup"><label>é€£çµ</label><input type="text" id="appLink" class="form-control"></div>
                        <div class="form-group" id="fileGroup" style="display:none;"><label>ä¸Šå‚³åœ–ç‰‡</label><input type="file" id="appFile" class="form-control" accept="image/*"><input type="hidden" id="appFileBase64"></div>
                        <div class="form-group"><label>è§£æ±ºäº†ä»€éº¼é›£é»ï¼Ÿ</label><input type="text" id="appPainPoint" class="form-control"></div>
                        <div class="form-group"><label style="color:var(--danger)">âš ï¸ ç‰¹åˆ¥å‚™è¨»</label><input type="text" id="appRemarks" class="form-control"></div>
                    </div>
                    
                    <div id="promptForm" style="display:none;">
                        <div class="form-group"><label>ä¸»é¡Œ</label><input type="text" id="promptTitle" class="form-control"></div>
                        <div class="form-group"><label>å…§å®¹ (é»‘åº•ç¶ å­—)</label><textarea id="promptContent" class="form-control" rows="8"></textarea></div>
                        <div class="form-group"><label>ç”¨é€” ğŸ¯</label><input type="text" id="promptPurpose" class="form-control"></div>
                    </div>
                    <button id="submitBtn" class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="submitUpload()">ç¢ºèªç™¼å¸ƒ</button>
                    <button id="cancelBtn" class="btn btn-outline" style="width:100%; margin-top:10px; display:none;" onclick="resetForm(true)">å–æ¶ˆç·¨è¼¯</button>
                </div>
            </div>
        </div>
    </div>

    <!-- APP DETAIL MODAL -->
    <div id="appDetailModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="modalAppTitle" style="margin:0;"></h2>
                <button class="btn btn-outline btn-round" onclick="document.getElementById('appDetailModal').style.display='none'">âœ•</button>
            </div>
            <div class="modal-body">
                <div>
                    <div id="modalAppPreview" style="width:100%; height:200px; background:#eee; border-radius:8px; margin-bottom:15px; overflow:hidden; display:flex; align-items:center; justify-content:center;"></div>
                    <div style="margin-bottom:15px;"><span class="tag" id="modalAppAuthor"></span> <span class="tag" id="modalAppDate"></span></div>
                    <p id="modalAppDesc" style="color:#555; line-height:1.6;"></p>
                    <div id="modalAppTags" class="tag-row" style="margin-bottom:20px;"></div>
                    <a id="modalAppLink" href="#" target="_blank" class="btn btn-primary" style="width:100%; padding:15px;">ğŸš€ é–‹å•Ÿè³‡æºé€£çµ</a>
                </div>
                <div>
                    <!-- V5.0 Guest Lock -->
                    <div id="ratingSection" class="rating-section">
                        <h4>ğŸ“Š è©•åˆ†</h4>
                        <div style="margin-bottom:10px;"><label>æ˜“ç”¨åº¦: <span id="usabilityVal">0</span>/5</label><div class="star-input" id="starUsability"><span onclick="rate(1,'u')">â˜…</span><span onclick="rate(2,'u')">â˜…</span><span onclick="rate(3,'u')">â˜…</span><span onclick="rate(4,'u')">â˜…</span><span onclick="rate(5,'u')">â˜…</span></div></div>
                        <div><label>æˆæ•ˆ: <span id="effectiveVal">0</span>/5</label><div class="star-input" id="starEffective"><span onclick="rate(1,'e')">â˜…</span><span onclick="rate(2,'e')">â˜…</span><span onclick="rate(3,'e')">â˜…</span><span onclick="rate(4,'e')">â˜…</span><span onclick="rate(5,'e')">â˜…</span></div></div>
                        <button class="btn btn-success btn-xs" style="margin-top:10px; width:100%" onclick="submitRating()">é€å‡ºè©•åˆ†</button>
                    </div>
                    <div class="comment-box" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                        <h4>ğŸ’¬ ç•™è¨€</h4>
                        <div id="commentList" style="max-height:200px; overflow-y:auto; margin-bottom:10px;"></div>
                        <div id="commentInputArea">
                            <textarea id="newComment" class="form-control" rows="2" placeholder="å¯«ä¸‹çœ‹æ³•..."></textarea>
                            <button class="btn btn-primary btn-xs" onclick="submitComment()">ç•™è¨€</button>
                        </div>
                        <div id="guestMsg" style="display:none; color:#999; text-align:center;">è¨ªå®¢æ¨¡å¼ç„¡æ³•è©•åˆ†æˆ–ç•™è¨€</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Config ---
        const firebaseConfig = { apiKey: "AIzaSyBPRN5_vnvMOPAR0fTVaZoqM57ffIGZOQU", authDomain: "bck-ai-hub.firebaseapp.com", projectId: "bck-ai-hub", storageBucket: "bck-ai-hub.firebasestorage.app", messagingSenderId: "1010987556331", appId: "1:1010987556331:web:07dac81847056ae7520dae" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentUser=null, currentAppId=null, currentRating={u:0,e:0};
        const teacherDirectory = { "lwysams@bcklas.edu.hk": "ç©", "slssams@bcklas.edu.hk": "çŠ", "ckysams@bcklas.edu.hk": "å¾", "cymsams@bcklas.edu.hk": "æ–‡", "lysams@bcklas.edu.hk": "ç‡•", "hhysams@bcklas.edu.hk": "ä¾¯", "scysams@bcklas.edu.hk": "è˜‡", "ccwsams@bcklas.edu.hk": "ç‘‹", "ynysams@bcklas.edu.hk": "æ¥Š", "csysams@bcklas.edu.hk": "æ·‘", "dspsams@bcklas.edu.hk": "ä¸", "cherry@bcklas.edu.hk": "Cherry", "lslsams@bcklas.edu.hk": "éˆ´", "cpy2sams@bcklas.edu.hk": "å®¹", "lsysams@bcklas.edu.hk": "å‘‚", "twksams@bcklas.edu.hk": "æ…§", "wpwsams@bcklas.edu.hk": "æ¦®", "skysams@bcklas.edu.hk": "å…’", "cym2sams@bcklas.edu.hk": "ç¶º", "swysams@bcklas.edu.hk": "æ²ˆ", "whwsams@bcklas.edu.hk": "é¦¨", "ywysams@bcklas.edu.hk": "ä¿" };
        const ADMIN_EMAIL = "lwysams@bcklas.edu.hk";
        const GUEST_PASS = "26754411!";
        
        const subList=["ä¸­æ–‡","è‹±æ–‡","æ•¸å­¸","å¸¸è­˜/ç§‘å­¸","äººæ–‡","è¦–è—","éŸ³æ¨‚","é«”è‚²","åœ–æ›¸","æ™®é€šè©±","ä½›å­¸","ç§‘æŠ€","åƒ¹å€¼è§€æ•™è‚²"];
        const adminCols = {"æ ¡å‹™é‹ä½œ":"#3498db","æ–‡æ›¸è™•ç†":"#9b59b6","æ•¸æ“šåˆ†æ":"#2ecc71","è³‡è¨Šé€šè¨Š":"#e67e22","æ´»å‹•ç­–åŠƒ":"#e74c3c","è³‡æºç®¡ç†":"#f1c40f"};
        const subCols = {"ä¸­æ–‡":"#e74c3c","è‹±æ–‡":"#3498db","æ•¸å­¸":"#f39c12","å¸¸è­˜/ç§‘å­¸":"#27ae60","äººæ–‡":"#8e44ad","è¦–è—":"#e91e63","éŸ³æ¨‚":"#1abc9c","é«”è‚²":"#34495e","åœ–æ›¸":"#d35400","æ™®é€šè©±":"#c0392b","ä½›å­¸":"#f1c40f","ç§‘æŠ€":"#16a085","åƒ¹å€¼è§€æ•™è‚²":"#e91e63","è·¨èª²ç¨‹":"#7f8c8d"};

        // --- Init ---
        subList.forEach(s => document.getElementById('crossSubChecks').innerHTML += `<label><input type="checkbox" value="${s}"> ${s}</label>`);

        auth.onAuthStateChanged(u => {
            if(u){ currentUser={name:teacherDirectory[u.email]||u.email.split('@')[0], email:u.email, uid:u.uid, isGuest:false}; document.getElementById('loginModal').style.display='none'; initApp(); }
            else if(!currentUser?.isGuest) document.getElementById('loginModal').style.display='flex';
        });

        function handleLogin(){
            const e=document.getElementById('loginEmail').value, p=document.getElementById('loginPass').value;
            if(p===GUEST_PASS){ currentUser={name:"è¨ªå®¢ (Guest)", isGuest:true}; document.getElementById('loginModal').style.display='none'; initApp(); return; }
            auth.signInWithEmailAndPassword(e,p).catch(err=>document.getElementById('loginMsg').innerText=err.message);
        }
        function logout(){ auth.signOut().then(()=>location.reload()); }

        function initApp(){
            document.getElementById('currentUserDisplay').innerText = currentUser.name;
            if(currentUser.isGuest) {
                document.getElementById('menu-upload').style.display='none'; // Hide upload menu for guest
                document.getElementById('uploadFormContent').style.display='none';
                document.getElementById('guestUploadMsg').style.display='block';
            }
            if(currentUser.email===ADMIN_EMAIL) document.getElementById('editAnnouncementBtn').style.display='inline-block';
            loadData(); loadAnnouncement();
        }

        async function loadAnnouncement(){
            try { const doc=await db.collection('settings').doc('announcement').get(); if(doc.exists) document.getElementById('announcementText').innerText=doc.data().text; } catch(e){}
        }
        async function editAnnouncement(){
            const t = prompt("è¼¸å…¥å…¬å‘Š:", document.getElementById('announcementText').innerText);
            if(t){ await db.collection('settings').doc('announcement').set({text:t}); loadAnnouncement(); }
        }

        async function loadData(){
            const apps = (await db.collection('apps').orderBy('timestamp','desc').get()).docs.map(d=>({id:d.id,...d.data()}));
            const prompts = (await db.collection('prompts').orderBy('timestamp','desc').get()).docs.map(d=>({id:d.id,...d.data()}));
            renderApps(apps); renderPrompts(prompts); renderDashboard(apps,prompts);
        }

        // --- Render Functions ---
        function renderDashboard(apps, prompts){
            const tApps = apps.filter(a=>a.category==='teaching');
            const aApps = apps.filter(a=>a.category==='admin');
            
            document.getElementById('totalApps').innerText = apps.length + prompts.length;
            document.getElementById('totalAdmin').innerText = aApps.length;
            document.getElementById('totalTeaching').innerText = tApps.length;
            document.getElementById('totalPrompts').innerText = prompts.length;
            document.getElementById('activeTeachers').innerText = new Set([...apps.map(a=>a.author), ...prompts.map(p=>p.author)]).size;

            // 1. Charts
            const subC={}; tApps.forEach(a=>subC[a.subject||'å…¶ä»–']=(subC[a.subject||'å…¶ä»–']||0)+1);
            if(window.c1)window.c1.destroy();
            window.c1 = new Chart(document.getElementById('subjectChart'),{type:'pie',data:{labels:Object.keys(subC),datasets:[{data:Object.values(subC),backgroundColor:Object.keys(subC).map(k=>subCols[k]||'#999')}]}});

            const admC={}; aApps.forEach(a=>admC[a.adminType||'å…¶ä»–']=(admC[a.adminType||'å…¶ä»–']||0)+1);
            if(window.c2)window.c2.destroy();
            window.c2 = new Chart(document.getElementById('adminChart'),{type:'bar',data:{labels:Object.keys(admC),datasets:[{label:'æ•¸é‡',data:Object.values(admC),backgroundColor:Object.keys(admC).map(k=>adminCols[k]||'#999')}]},options:{plugins:{legend:{display:false}}}});

            const fC={Creativity:0,'Critical Thinking':0,Communication:0,Collaboration:0,Contribution:0};
            apps.forEach(a=>{if(a.fiveC)a.fiveC.forEach(c=>{if(fC[c]!==undefined)fC[c]++})});
            if(window.c3)window.c3.destroy();
            window.c3 = new Chart(document.getElementById('fiveCChart'),{type:'radar',data:{labels:Object.keys(fC),datasets:[{label:'5C+',data:Object.values(fC),backgroundColor:'rgba(46,204,113,0.4)',borderColor:'#2ecc71'}]},options:{scales:{r:{beginAtZero:true}}}});

            // 2. Leaderboards
            // Active Contributors
            const auths = {};
            [...apps,...prompts].forEach(x=>{ auths[x.author]=(auths[x.author]||0)+1; });
            const lb1 = Object.entries(auths).sort((a,b)=>b[1]-a[1]).slice(0,5);
            document.querySelector('#contributorTable tbody').innerHTML = lb1.map((x,i)=>`<tr><td><span class="rank-badge ${i<3?'rank-'+(i+1):''}">${i+1}</span></td><td>${x[0]}</td><td>${x[1]}</td></tr>`).join('');

            // Top Rated
            const rated = apps.map(a=>{
                const rs=Object.values(a.ratings||{});
                const s = rs.length ? rs.reduce((acc,r)=>acc+(r.u+r.e)/2,0)/rs.length : 0;
                return {t:a.title, a:a.author, s:s.toFixed(1)};
            }).filter(x=>x.s>0).sort((a,b)=>b.s-a.s).slice(0,5);
            document.querySelector('#topRatedTable tbody').innerHTML = rated.map((x,i)=>`<tr><td>${i+1}</td><td>${x.t}</td><td>${x.s}</td></tr>`).join('');
        }

        function renderApps(apps){
            const c=document.getElementById('appsContainer'); c.innerHTML='';
            apps.forEach(app=>{
                let img='';
                if(app.resourceType==='image' && app.link && app.link.startsWith('data:')) img=`<img src="${app.link}" class="card-img">`;
                else {
                    const icons={url:'ğŸ”—',video:'ğŸ¬',presentation:'ğŸ“Š',worksheet:'ğŸ“„',lessonplan:'ğŸ“'};
                    img=`<div class="card-placeholder ${app.category==='admin'?'bg-admin':'bg-teaching'}"><div class="ph-icon">${icons[app.resourceType]||'ğŸ”—'}</div></div>`;
                }
                
                let tags = `<span class="tag">${app.subject||app.adminType}</span>`;
                if(app.fiveC) app.fiveC.forEach(t=>tags+=`<span class="tag tag-5c">${t}</span>`);

                const remarks = app.remarks ? `<div class="remark-alert" style="margin-bottom:5px;padding:5px;">âš ï¸ ${app.remarks}</div>` : '';
                const editBtn = (!currentUser.isGuest && (app.author===currentUser.name || app.authorEmail===currentUser.email)) ? `<button class="btn btn-outline btn-xs" style="float:right" onclick='editApp(${JSON.stringify(app)})'>âœï¸</button>` : '';

                c.innerHTML += `
                <div class="card" data-cat="${app.category}" data-sub="${app.subject}" onclick="openAppDetail('${app.id}')">
                    <div class="card-preview-area">${img}</div>
                    <div class="card-content">
                        <h3 class="card-title">${app.title} ${editBtn}</h3>
                        <div class="card-meta"><span>${app.author}</span><span>${new Date(app.timestamp).toLocaleDateString()}</span></div>
                        ${remarks}
                        <div class="tag-row">${tags}</div>
                        <div class="card-desc">${app.painPoint||''}</div>
                    </div>
                </div>`;
            });
        }

        function renderPrompts(prompts){
            const c=document.getElementById('promptsContainer'); c.innerHTML='';
            prompts.forEach(p=>{
                 const editBtn = (!currentUser.isGuest && (p.author===currentUser.name || p.authorEmail===currentUser.email)) ? `<button class="btn btn-outline btn-xs" style="float:right" onclick='editPrompt(${JSON.stringify(p)})'>âœï¸</button>` : '';
                 c.innerHTML += `
                 <div class="prompt-card">
                    <div class="prompt-meta"><span>${p.title}</span> <span>${p.author}</span></div>
                    <div style="font-size:1.1rem; margin-bottom:10px;">ğŸ¯ ${p.purpose} ${editBtn}</div>
                    <div class="prompt-content-box">${p.content}</div>
                    <button class="btn btn-outline btn-xs" onclick="navigator.clipboard.writeText(\`${p.content.replace(/`/g,'\\`')}\`);alert('Copied!')">ğŸ“‹ Copy Code</button>
                 </div>`;
            });
        }

        // --- Detail Modal ---
        async function openAppDetail(id){
            // Prevent event bubbling from edit button
            if(event && event.target.tagName === 'BUTTON') return;
            
            currentAppId=id;
            const app = (await db.collection('apps').doc(id).get()).data();
            document.getElementById('modalAppTitle').innerText=app.title;
            document.getElementById('modalAppAuthor').innerText=app.author;
            document.getElementById('modalAppDate').innerText=new Date(app.timestamp).toLocaleDateString();
            document.getElementById('modalAppDesc').innerText=app.painPoint;
            document.getElementById('modalAppLink').href=app.link;
            
            // Preview
            const pBox=document.getElementById('modalAppPreview');
            if(app.resourceType==='image' && app.link.startsWith('data:')) pBox.innerHTML=`<img src="${app.link}" style="height:100%">`;
            else pBox.innerHTML=`<div style="font-size:3rem">ğŸ”—</div>`;

            // Tags
            let tags = `<span class="tag">${app.subject||app.adminType}</span>`;
            if(app.fiveC) app.fiveC.forEach(t=>tags+=`<span class="tag tag-5c">${t}</span>`);
            document.getElementById('modalAppTags').innerHTML=tags;

            // Comments
            const cList=document.getElementById('commentList'); cList.innerHTML='';
            if(app.comments) app.comments.forEach(c=>cList.innerHTML+=`<div style="border-bottom:1px solid #eee;padding:5px"><b>${c.author}</b>: ${c.content}</div>`);
            
            // Guest Lock
            if(currentUser.isGuest){
                document.getElementById('ratingSection').style.opacity='0.5';
                document.getElementById('ratingSection').style.pointerEvents='none';
                document.getElementById('commentInputArea').style.display='none';
                document.getElementById('guestMsg').style.display='block';
            } else {
                document.getElementById('ratingSection').style.opacity='1';
                document.getElementById('ratingSection').style.pointerEvents='auto';
                document.getElementById('commentInputArea').style.display='block';
                document.getElementById('guestMsg').style.display='none';
            }
            
            document.getElementById('appDetailModal').style.display='flex';
        }
        
        function rate(v,t){ currentRating[t]=v; document.getElementById(t==='u'?'usabilityVal':'effectiveVal').innerText=v; }
        function submitRating(){ db.collection('apps').doc(currentAppId).set({ratings:{[currentUser.uid]:currentRating}},{merge:true}).then(()=>alert('Done')); }
        function submitComment(){ const t=document.getElementById('newComment').value; if(t) db.collection('apps').doc(currentAppId).update({comments:firebase.firestore.FieldValue.arrayUnion({author:currentUser.name,content:t,timestamp:Date.now()})}).then(()=>openAppDetail(currentAppId)); }

        // --- Standard Actions ---
        function showPage(id){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); if(window.innerWidth<=768) toggleSidebar(); }
        function toggleSidebar(){ document.querySelector('.sidebar').classList.toggle('active'); document.querySelector('.sidebar-overlay').classList.toggle('active'); }
        function filterApps(t){ document.querySelectorAll('#appsContainer .card').forEach(c=>c.style.display=(t==='all'||c.dataset.cat===t||(t==='value'&&c.dataset.sub==='åƒ¹å€¼è§€æ•™è‚²'))?'flex':'none'); }
        
        // Upload Helpers
        function toggleUploadForm(){ const t=document.getElementById('uploadType').value; document.getElementById('appForm').style.display=t==='app'?'block':'none'; document.getElementById('promptForm').style.display=t==='prompt'?'block':'none'; }
        function handleCatChange(){ const adm=document.getElementById('appCategory').value==='admin'; document.getElementById('admGroup').style.display=adm?'block':'none'; document.getElementById('subjGroup').style.display=adm?'none':'block'; document.getElementById('5cGroup').style.display=adm?'none':'block'; }
        function handleSubjChange(){ document.getElementById('crossSubSection').style.display=document.getElementById('appSubject').value==='è·¨èª²ç¨‹'?'block':'none'; }
        function handleResType(){ const t=document.getElementById('resourceType').value; document.getElementById('fileGroup').style.display=t==='image'?'block':'none'; document.getElementById('urlGroup').style.display=t==='image'?'none':'block'; }
        document.getElementById('appFile').addEventListener('change', e=>{const r=new FileReader(); r.onload=()=>document.getElementById('appFileBase64').value=r.result; r.readAsDataURL(e.target.files[0]);});

        async function submitUpload(){
            if(currentUser.isGuest) return;
            const isEdit = document.getElementById('editModeId').value !== "";
            const type = document.getElementById('uploadType').value;
            const base = { author: currentUser.name, uid: currentUser.uid, timestamp: Date.now() };
            
            if(type==='app'){
                const fiveC=[]; document.querySelectorAll('input[name="5c"]:checked').forEach(c=>fiveC.push(c.value));
                const cross=[]; document.querySelectorAll('#crossSubChecks input:checked').forEach(c=>cross.push(c.value));
                const d = {...base, title:document.getElementById('appTitle').value, category:document.getElementById('appCategory').value, subject:document.getElementById('appSubject').value, adminType:document.getElementById('appAdminType').value, resourceType:document.getElementById('resourceType').value, link:document.getElementById('appLink').value, painPoint:document.getElementById('appPainPoint').value, promptText:document.getElementById('appPrompt').value, remarks:document.getElementById('appRemarks').value, fiveC:fiveC, crossSubjects:cross};
                if(d.resourceType==='image') d.link=document.getElementById('appFileBase64').value;
                if(!isEdit) { d.ratings={}; d.comments=[]; }
                
                const action = isEdit ? db.collection('apps').doc(document.getElementById('editModeId').value).update(d) : db.collection('apps').add(d);
                action.then(()=>{alert('æˆåŠŸ'); loadData(); resetForm();});
            } else {
                const d = {...base, title:document.getElementById('promptTitle').value, content:document.getElementById('promptContent').value, purpose:document.getElementById('promptPurpose').value};
                const action = isEdit ? db.collection('prompts').doc(document.getElementById('editModeId').value).update(d) : db.collection('prompts').add(d);
                action.then(()=>{alert('æˆåŠŸ'); loadData(); resetForm();});
            }
        }

        // Edit & Reset
        function editApp(app){
            showPage('upload'); document.getElementById('editModeId').value=app.id; document.getElementById('uploadType').value='app'; toggleUploadForm();
            document.getElementById('appTitle').value=app.title; document.getElementById('appCategory').value=app.category; handleCatChange();
            document.getElementById('appSubject').value=app.subject||""; handleSubjChange();
            document.querySelectorAll('#crossSubChecks input').forEach(c=>c.checked=false); (app.crossSubjects||[]).forEach(s=>{try{document.querySelector(`#crossSubChecks input[value="${s}"]`).checked=true}catch(e){}});
            document.getElementById('appAdminType').value=app.adminType||"";
            document.getElementById('resourceType').value=app.resourceType||"url"; handleResType();
            if(app.resourceType==='image') document.getElementById('appFileBase64').value=app.link; else document.getElementById('appLink').value=app.link;
            document.getElementById('appPainPoint').value=app.painPoint; document.getElementById('appPrompt').value=app.promptText||""; document.getElementById('appRemarks').value=app.remarks||"";
            document.querySelectorAll('input[name="5c"]').forEach(c=>c.checked=false); (app.fiveC||[]).forEach(v=>{try{document.querySelector(`input[name="5c"][value="${v}"]`).checked=true}catch(e){}});
            
            document.getElementById('submitBtn').innerText="ç¢ºèªæ›´æ–°";
            document.getElementById('cancelBtn').style.display='inline-block';
            document.getElementById('deleteBtn').style.display='inline-block';
        }

        function editPrompt(p){
            showPage('upload'); document.getElementById('editModeId').value=p.id; document.getElementById('uploadType').value='prompt'; toggleUploadForm();
            document.getElementById('promptTitle').value=p.title; document.getElementById('promptContent').value=p.content; document.getElementById('promptPurpose').value=p.purpose;
            document.getElementById('submitBtn').innerText="ç¢ºèªæ›´æ–°";
            document.getElementById('cancelBtn').style.display='inline-block';
            document.getElementById('deleteBtn').style.display='inline-block';
        }

        function resetForm(redirect=false){
            document.getElementById('editModeId').value=""; document.querySelectorAll('input,textarea').forEach(i=>i.value="");
            document.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false);
            document.getElementById('submitBtn').innerText="ç¢ºèªç™¼å¸ƒ"; document.getElementById('cancelBtn').style.display='none'; document.getElementById('deleteBtn').style.display='none';
            if(redirect) showPage('apps');
        }

        function deleteResource(){
            const id=document.getElementById('editModeId').value; if(!id)return;
            if(confirm("ç¢ºå®šåˆªé™¤?")){ const col=document.getElementById('uploadType').value==='app'?'apps':'prompts'; db.collection(col).doc(id).delete().then(()=>{alert('å·²åˆªé™¤'); resetForm(true); loadData();}); }
        }

        function exportDataReport(){
            const csvContent = "data:text/csv;charset=utf-8,ID,Title,Author\nDemo,Data,Only";
            const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", "report.csv"); document.body.appendChild(link); link.click();
        }
    </script>
</body>
</html>