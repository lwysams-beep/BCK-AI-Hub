<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCK-AI Hub | æ­£è¦ºè“®ç¤¾ AI æ™ºæ…§åº« V1.2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        /* CSS æ¨£å¼ç¶­æŒä¸è®Šï¼Œä¿æŒ V1.1 çš„ç¾è§€è¨­è¨ˆ */
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --light: #ecf0f1;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --admin-color: #8e44ad;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f4f7f6; display: flex; height: 100vh; }
        .sidebar { width: 260px; background-color: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .page { display: none; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .sidebar h2 { font-size: 1.3rem; margin-bottom: 20px; text-align: center; border-bottom: 1px solid #546e7a; padding-bottom: 15px; }
        .menu-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; }
        .menu-item:hover, .menu-item.active { background-color: var(--accent); transform: translateX(5px); }
        .menu-icon { margin-right: 10px; width: 20px; text-align: center; }
        .user-info { margin-top: auto; padding-top:20px; border-top:1px solid #546e7a; font-size: 0.9rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid var(--accent); }
        .stat-number { font-size: 2.5rem; font-weight: 800; color: var(--primary); margin: 10px 0; }
        .charts-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .resource-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .card.teaching { border-top: 5px solid var(--accent); }
        .card.admin { border-top: 5px solid var(--admin-color); }
        .rating-badge-container { display: flex; gap: 10px; margin: 15px 0; }
        .badge-rate { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px 10px; border-radius: 8px; color: white; font-weight: bold; min-width: 60px; }
        .bg-ease { background: linear-gradient(135deg, #f1c40f, #f39c12); }
        .bg-effect { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .rate-label { font-size: 0.7rem; text-transform: uppercase; opacity: 0.9; }
        .rate-score { font-size: 1.2rem; }
        .tag { background: #f0f2f5; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; color: #555; margin-right: 5px; display: inline-block; margin-bottom: 5px;}
        .smart-tag { background: #e8f6f3; color: var(--success); border: 1px solid #d4efdf; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; font-weight: 600; }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-admin { background-color: var(--admin-color); color: white; }
        .btn-outline { border: 1px solid #ccc; background: white; color: #555; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        .form-control:disabled { background-color: #e9ecef; cursor: not-allowed; opacity: 0.7; }
        #loginModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="loginModal">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-top:0;">BCK-AI Hub V1.2</h2>
            <p style="color:#7f8c8d; margin-bottom:20px;">è«‹ä½¿ç”¨æ ¡æ–¹æ´¾ç™¼çš„å¸³è™Ÿç™»å…¥</p>
            
            <input type="email" id="loginEmail" class="form-control" placeholder="Email (ä¾‹å¦‚: chan@bck.edu.hk)" style="margin-bottom:10px;">
            <input type="password" id="loginPass" class="form-control" placeholder="Password" style="margin-bottom:20px;">
            
            <button id="loginBtn" class="btn btn-primary" style="width:100%" onclick="handleLogin()">ç™»å…¥ç³»çµ±</button>
            <p style="margin-top:15px; font-size:0.8rem; color:#e74c3c;" id="loginMsg"></p>
        </div>
    </div>

    <div class="sidebar">
        <h2>BCK-AI Hub</h2>
        <div class="menu-item active" onclick="showPage('dashboard')"><span class="menu-icon">ğŸ“Š</span> æ•¸æ“šç¸½è¦½</div>
        <div class="menu-item" onclick="showPage('apps')"><span class="menu-icon">ğŸ“±</span> æ‡‰ç”¨ç¨‹å¼åº«</div>
        <div class="menu-item" onclick="showPage('prompts')"><span class="menu-icon">ğŸ’¡</span> Prompt åˆ†äº«</div>
        <div class="menu-item" onclick="showPage('upload')"><span class="menu-icon">ğŸ“¤</span> ä¸Šè¼‰åˆ†äº«</div>
        
        <div class="user-info">
            <p>ğŸ‘‹ <span id="currentUserDisplay">...</span> è€å¸«</p>
            <button class="btn btn-outline" style="width:100%; font-size:0.8rem;" onclick="logout()">ç™»å‡º</button>
        </div>
    </div>

    <div class="main-content">
        
        <div id="dashboard" class="page active">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1>å¹³å°æ•¸æ“šå„€è¡¨æ¿</h1>
                <button class="btn btn-success" onclick="exportDataReport()">ğŸ“¥ åŒ¯å‡ºæ•¸æ“šå ±å‘Š (CSV)</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card" style="border-bottom-color: var(--accent);">
                    <div class="stat-number" id="totalApps">0</div>
                    <div>å­¸æ•™è©•è³‡æº</div>
                </div>
                <div class="stat-card" style="border-bottom-color: var(--admin-color);">
                    <div class="stat-number" id="totalAdmin">0</div>
                    <div>è¡Œæ”¿æ•ˆèƒ½å·¥å…·</div>
                </div>
                <div class="stat-card" style="border-bottom-color: var(--warning);">
                    <div class="stat-number" id="totalPrompts">0</div>
                    <div>Prompt æŒ‡ä»¤</div>
                </div>
                <div class="stat-card" style="border-bottom-color: var(--success);">
                    <div class="stat-number" id="activeTeachers">0</div>
                    <div>åƒèˆ‡è€å¸«</div>
                </div>
            </div>

            <div class="charts-section">
                <div class="chart-box">
                    <h3 style="color:var(--accent)">ğŸ“ å­¸æ•™è©•ï¼š5C+ ç´ é¤Šåˆ†ä½ˆ</h3>
                    <canvas id="teachingChart"></canvas>
                </div>
                <div class="chart-box">
                    <h3 style="color:var(--admin-color)">ğŸ“‚ è¡Œæ”¿ï¼šæ•ˆèƒ½é¡åˆ¥åˆ†æ</h3>
                    <canvas id="adminChart"></canvas>
                </div>
            </div>
            
            <div class="chart-box">
                <h3>ğŸ† æ´»èºè²¢ç»æ’è¡Œæ¦œ</h3>
                <ul id="leaderboardList" style="list-style: none; padding: 0;"></ul>
            </div>
        </div>

        <div id="apps" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1>æ‡‰ç”¨ç¨‹å¼åº«</h1>
                <div>
                    <button class="btn btn-primary" onclick="filterApps('all')">å…¨éƒ¨</button>
                    <button class="btn btn-primary" style="background:var(--accent)" onclick="filterApps('teaching')">å­¸æ•™è©•</button>
                    <button class="btn btn-admin" onclick="filterApps('admin')">è¡Œæ”¿</button>
                </div>
            </div>
            <div id="appsContainer" class="resource-grid"></div>
        </div>

        <div id="prompts" class="page">
            <h1>å¥½ Prompt åˆ†äº«å€</h1>
            <div id="promptsContainer" class="resource-grid"></div>
        </div>

        <div id="upload" class="page">
            <h1>ä¸Šè¼‰ / ç·¨è¼¯è³‡æº</h1>
            <div style="background:white; padding:30px; border-radius:12px; max-width: 800px; margin:0 auto;">
                
                <input type="hidden" id="editModeId" value="">

                <div class="form-group">
                    <label>è³‡æºé¡å‹</label>
                    <select id="uploadType" class="form-control" onchange="toggleUploadForm()">
                        <option value="app">App / ç¶²ä»¶</option>
                        <option value="prompt">AI Prompt (æŒ‡ä»¤)</option>
                    </select>
                </div>

                <div id="appForm">
                    <div class="form-group">
                        <label>ä½œå“åç¨±</label>
                        <input type="text" id="appTitle" class="form-control" placeholder="ä¾‹å¦‚ï¼šè‡ªå‹•å‡ºå·ç¥å™¨">
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div class="form-group">
                            <label>ä¸»åˆ†é¡</label>
                            <select id="appCategory" class="form-control" onchange="handleCategoryChange()">
                                <option value="teaching">å­¸æ•™è©• (Teaching)</option>
                                <option value="admin">è¡Œæ”¿ (Admin)</option>
                            </select>
                        </div>
                        <div class="form-group" id="subjectGroup">
                            <label>é©ç”¨ç§‘ç›®</label>
                            <select id="appSubject" class="form-control">
                                <option value="ä¸­æ–‡">ä¸­æ–‡</option>
                                <option value="è‹±æ–‡">è‹±æ–‡</option>
                                <option value="æ•¸å­¸">æ•¸å­¸</option>
                                <option value="å¸¸è­˜/ç§‘å­¸">å¸¸è­˜/ç§‘å­¸</option>
                                <option value="äººæ–‡">äººæ–‡</option>
                                <option value="è¦–è—">è¦–è—</option>
                                <option value="éŸ³æ¨‚">éŸ³æ¨‚</option>
                                <option value="é«”è‚²">é«”è‚²</option>
                                <option value="åœ–æ›¸">åœ–æ›¸</option>
                                <option value="æ™®é€šè©±">æ™®é€šè©±</option>
                                <option value="ä½›å­¸">ä½›å­¸</option>
                                <option value="ç§‘æŠ€">ç§‘æŠ€</option>
                                <option value="è·¨èª²ç¨‹">è·¨èª²ç¨‹</option>
                            </select>
                        </div>
                        <div class="form-group" id="adminTypeGroup" style="display:none;">
                            <label>è¡Œæ”¿é¡åˆ¥</label>
                            <select id="appAdminType" class="form-control">
                                <option value="æ–‡æ›¸è™•ç†">æ–‡æ›¸è™•ç†</option>
                                <option value="æ•¸æ“šåˆ†æ">æ•¸æ“šåˆ†æ</option>
                                <option value="æ´»å‹•ç­–åŠƒ">æ´»å‹•ç­–åŠƒ</option>
                                <option value="è³‡æºç®¡ç†">è³‡æºç®¡ç†</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>é€£çµ (URL)</label>
                        <input type="text" id="appLink" class="form-control" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>è§£æ±ºäº†ä»€éº¼é›£é»ï¼Ÿ</label>
                        <input type="text" id="appPainPoint" class="form-control" placeholder="ä¾‹å¦‚ï¼šç¯€çœäº†æ¯é€± 2 å°æ™‚çš„æ’ç‰ˆæ™‚é–“">
                    </div>
                    <div class="form-group">
                        <label>ç°¡ä»‹ (AI å°‡è¼”åŠ©æ¨™ç±¤)</label>
                        <textarea id="appDesc" class="form-control" rows="3" onblur="triggerAutoTag()" placeholder="è«‹æè¿°å·¥å…·åŠŸèƒ½..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>5C+ / é—œéµå­—æ¨™ç±¤ (å¯äººæ‰‹ä¿®æ”¹ï¼Œç”¨é€—è™Ÿåˆ†éš”)</label>
                        <input type="text" id="appTags" class="form-control" value="General">
                    </div>
                </div>

                <div id="promptForm" style="display:none;">
                    <div class="form-group">
                        <label>Prompt ä¸»é¡Œ</label>
                        <input type="text" id="promptTitle" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>æŒ‡ä»¤å…§å®¹</label>
                        <textarea id="promptContent" class="form-control" rows="6" style="font-family:monospace"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ç”¨é€”/ç›®æ¨™</label>
                        <input type="text" id="promptPurpose" class="form-control">
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button id="submitBtn" class="btn btn-primary" style="flex:1" onclick="submitUpload()">ç¢ºèªç™¼å¸ƒ</button>
                    <button id="cancelBtn" class="btn btn-outline" style="display:none" onclick="resetForm()">å–æ¶ˆç·¨è¼¯</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION ZONE V1.2
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyBPRN5_vnvMOPAR0fTVaZoqM57ffIGZOQU",
          authDomain: "bck-ai-hub.firebaseapp.com",
          projectId: "bck-ai-hub",
          storageBucket: "bck-ai-hub.firebasestorage.app",
          messagingSenderId: "1010987556331",
          appId: "1:1010987556331:web:07dac81847056ae7520dae"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // System State
        let currentUser = null;
        let teachingChartRef = null;
        let adminChartRef = null;

        // --- Auth Functions ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                // å¦‚æœæ²’æœ‰ display nameï¼Œé è¨­ç”¨ email å‰ç¶´ (e.g., "michael" from "michael@bck.edu.hk")
                const displayName = user.displayName || user.email.split('@')[0];
                currentUser = { 
                    name: displayName, 
                    email: user.email,
                    uid: user.uid
                };
                document.getElementById('loginModal').style.display = 'none';
                updateUserDisplay();
                loadData();
            } else {
                currentUser = null;
                document.getElementById('loginModal').style.display = 'flex';
            }
        });

        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            const msg = document.getElementById('loginMsg');
            
            msg.innerText = "ç™»å…¥ä¸­...";
            auth.signInWithEmailAndPassword(email, pass)
                .catch(error => {
                    msg.innerText = "ç™»å…¥å¤±æ•—: " + error.message;
                });
        }

        function logout() {
            auth.signOut().then(() => location.reload());
        }

        function updateUserDisplay() {
            document.getElementById('currentUserDisplay').innerText = currentUser.name;
        }

        // --- Data Logic (Firebase) ---
        async function loadData() {
            try {
                // Fetch Apps
                const appsSnap = await db.collection('apps').orderBy('timestamp', 'desc').get();
                const apps = appsSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                // Fetch Prompts
                const promptsSnap = await db.collection('prompts').orderBy('timestamp', 'desc').get();
                const prompts = promptsSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                // Render
                renderDashboard(apps, prompts);
                renderApps(apps);
                renderPrompts(prompts);
            } catch (e) {
                console.error("Error loading data:", e);
                alert("æ•¸æ“šè®€å–éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥");
            }
        }

        // --- Render Apps ---
        function renderApps(apps) {
            const container = document.getElementById('appsContainer');
            container.innerHTML = '';
            
            apps.forEach(app => {
                const tagsHtml = Array.isArray(app.tags) 
                    ? app.tags.map(t => `<span class="tag smart-tag">ğŸ¤– ${t}</span>`).join('') 
                    : '';
                
                const catBadge = app.category === 'teaching' 
                    ? `<span class="tag" style="background:var(--accent); color:white">å­¸æ•™è©•: ${app.subject}</span>`
                    : `<span class="tag" style="background:var(--admin-color); color:white">è¡Œæ”¿: ${app.adminType}</span>`;

                // åªæœ‰åŸä½œè€…å¯çœ‹åˆ°ç·¨è¼¯æŒ‰éˆ• (åˆ¤æ–· UID æˆ– Email æˆ– Name)
                // é€™è£¡å¯¬é¬†åˆ¤æ–·ï¼šå¦‚æœä½œè€…åç›¸åŒå³å¯ç·¨è¼¯ (æ­£å¼ç‰ˆæ‡‰ç”¨ UID)
                const isAuthor = (app.author === currentUser.name) || (app.authorEmail && app.authorEmail === currentUser.email);
                const editBtn = isAuthor
                    ? `<button class="btn btn-outline" style="font-size:0.7rem; float:right" onclick='editApp(${JSON.stringify(app)})'>âœï¸ ç·¨è¼¯</button>` 
                    : '';

                // Fake Ratings (å¦‚éœ€çœŸå¯¦è©•åˆ†éœ€å†é–‹ collection)
                let avgEase = "4.5"; 
                let avgEffect = "4.2";

                let html = `
                    <div class="card ${app.category}" data-cat="${app.category}">
                        <h3>${app.title} ${editBtn}</h3>
                        <div style="font-size:0.85rem; color:#7f8c8d; margin-bottom:10px;">ç”± ${app.author} æä¾›</div>
                        <div>${catBadge}</div>
                        
                        <p style="font-size:0.9rem; color:#444"><strong>ğŸ’¡ è§£æ±ºé›£é»ï¼š</strong> ${app.painPoint}</p>
                        <p style="font-size:0.9rem;">${app.desc}</p>
                        
                        <div style="margin:10px 0;">${tagsHtml}</div>
                        
                        <div class="rating-badge-container">
                            <div class="badge-rate bg-ease">
                                <span class="rate-label">æ˜“ç”¨åº¦</span>
                                <span class="rate-score">${avgEase}</span>
                            </div>
                            <div class="badge-rate bg-effect">
                                <span class="rate-label">æˆæ•ˆ</span>
                                <span class="rate-score">${avgEffect}</span>
                            </div>
                        </div>

                        <a href="${app.link}" target="_blank" class="btn btn-primary" style="display:block; text-align:center">å‰å¾€å·¥å…·</a>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- Render Prompts & Others (Same logic as V1.1) ---
        function renderPrompts(prompts) {
            const container = document.getElementById('promptsContainer');
            container.innerHTML = '';
            prompts.forEach(p => {
                container.innerHTML += `
                    <div class="card">
                        <h3>${p.title} <small style="font-size:0.8rem">${p.author}</small></h3>
                        <p><strong>ğŸ¯ ç”¨é€”ï¼š</strong>${p.purpose}</p>
                        <div style="background:#2c3e50; color:#2ecc71; padding:15px; border-radius:8px; font-family:monospace; margin:10px 0; max-height:150px; overflow-y:auto; white-space:pre-wrap; font-size:0.9rem;">${p.content}</div>
                        <button class="btn btn-outline" onclick="navigator.clipboard.writeText(\`${p.content}\`);alert('å·²è¤‡è£½ï¼')">è¤‡è£½æŒ‡ä»¤</button>
                    </div>
                `;
            });
        }

        function filterApps(type) {
            const cards = document.querySelectorAll('.card[data-cat]');
            cards.forEach(c => {
                if(type === 'all') c.style.display = 'block';
                else c.style.display = c.getAttribute('data-cat') === type ? 'block' : 'none';
            });
        }

        function renderDashboard(apps, prompts) {
            const teachingApps = apps.filter(a => a.category === 'teaching');
            const adminApps = apps.filter(a => a.category === 'admin');
            
            document.getElementById('totalApps').innerText = teachingApps.length;
            document.getElementById('totalAdmin').innerText = adminApps.length;
            document.getElementById('totalPrompts').innerText = prompts.length;
            
            const authors = new Set([...apps.map(a=>a.author), ...prompts.map(p=>p.author)]);
            document.getElementById('activeTeachers').innerText = authors.size;

            // Teaching Chart
            const skillCounts = { "Communication":0, "Contribution":0, "Creativity":0, "Critical Thinking":0, "Collaboration":0 };
            teachingApps.forEach(a => {
                if(a.tags) a.tags.forEach(t => { if(skillCounts[t] !== undefined) skillCounts[t]++; });
            });
            const ctx1 = document.getElementById('teachingChart').getContext('2d');
            if(teachingChartRef) teachingChartRef.destroy();
            teachingChartRef = new Chart(ctx1, {
                type: 'radar',
                data: {
                    labels: Object.keys(skillCounts),
                    datasets: [{ label: '5C+ ç´ é¤Š', data: Object.values(skillCounts), backgroundColor: 'rgba(52, 152, 219, 0.2)', borderColor: '#3498db' }]
                },
                options: { scales: { r: { beginAtZero: true, suggestMax: 5 } } }
            });

            // Admin Chart
            const adminTypes = { "æ–‡æ›¸è™•ç†":0, "æ•¸æ“šåˆ†æ":0, "æ´»å‹•ç­–åŠƒ":0, "è³‡æºç®¡ç†":0 };
            adminApps.forEach(a => { if(a.adminType) adminTypes[a.adminType] = (adminTypes[a.adminType] || 0) + 1; });
            const ctx2 = document.getElementById('adminChart').getContext('2d');
            if(adminChartRef) adminChartRef.destroy();
            adminChartRef = new Chart(ctx2, {
                type: 'bar',
                data: { labels: Object.keys(adminTypes), datasets: [{ label: 'å·¥å…·åˆ†é¡', data: Object.values(adminTypes), backgroundColor: ['#8e44ad', '#9b59b6', '#af7ac5', '#c39bd3'] }] }
            });
            
            // Leaderboard
            const counts = {};
            [...apps, ...prompts].forEach(item => counts[item.author] = (counts[item.author]||0)+1);
            const lb = document.getElementById('leaderboardList');
            lb.innerHTML = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]).slice(0,5).map((t,i) => `<li>${i+1}. ${t} <span style="float:right; font-weight:bold; color:var(--accent)">${counts[t]} è²¢ç»</span></li><hr style="opacity:0.1; margin:5px 0">`).join('');
        }

        // --- Logic: Form Handling & Edit (Updated with Firebase) ---
        function handleCategoryChange() {
            const cat = document.getElementById('appCategory').value;
            const subEl = document.getElementById('appSubject');
            const adminEl = document.getElementById('adminTypeGroup');
            const subGroup = document.getElementById('subjectGroup');
            if (cat === 'admin') {
                subEl.disabled = true; subGroup.style.opacity = "0.5"; adminEl.style.display = 'block';
            } else {
                subEl.disabled = false; subGroup.style.opacity = "1"; adminEl.style.display = 'none';
            }
        }

        function triggerAutoTag() {
            const desc = document.getElementById('appDesc').value;
            const title = document.getElementById('appTitle').value;
            const currentTags = document.getElementById('appTags').value;
            if(currentTags === '' || currentTags === 'General') {
                let tags = [];
                const combined = desc + title;
                if(combined.includes("ç•«") || combined.includes("å‰µ")) tags.push("Creativity");
                if(combined.includes("å•") || combined.includes("æ€")) tags.push("Critical Thinking");
                if(combined.includes("çµ„") || combined.includes("åˆ")) tags.push("Collaboration");
                if(combined.includes("èªª") || combined.includes("è©±")) tags.push("Communication");
                if(combined.includes("å¹«") || combined.includes("äº«")) tags.push("Contribution");
                if(tags.length > 0) document.getElementById('appTags').value = tags.join(", ");
            }
        }

        function toggleUploadForm() {
            const type = document.getElementById('uploadType').value;
            document.getElementById('appForm').style.display = type === 'app' ? 'block' : 'none';
            document.getElementById('promptForm').style.display = type === 'prompt' ? 'block' : 'none';
        }

        function submitUpload() {
            const isEdit = document.getElementById('editModeId').value !== "";
            const collection = document.getElementById('uploadType').value === 'app' ? 'apps' : 'prompts';
            
            const data = {
                title: document.getElementById(collection === 'apps' ? 'appTitle' : 'promptTitle').value,
                author: currentUser.name,
                authorEmail: currentUser.email,
                timestamp: Date.now()
            };

            if(collection === 'apps') {
                Object.assign(data, {
                    category: document.getElementById('appCategory').value,
                    subject: document.getElementById('appSubject').value,
                    adminType: document.getElementById('appAdminType').value,
                    link: document.getElementById('appLink').value,
                    painPoint: document.getElementById('appPainPoint').value,
                    desc: document.getElementById('appDesc').value,
                    tags: document.getElementById('appTags').value.split(',').map(s=>s.trim())
                });
            } else {
                Object.assign(data, {
                    content: document.getElementById('promptContent').value,
                    purpose: document.getElementById('promptPurpose').value
                });
            }

            const action = isEdit 
                ? db.collection(collection).doc(document.getElementById('editModeId').value).update(data)
                : db.collection(collection).add(data);

            action.then(() => {
                alert(isEdit ? "æ›´æ–°æˆåŠŸ" : "ç™¼å¸ƒæˆåŠŸ");
                resetForm();
                loadData();
                showPage(collection === 'apps' ? 'apps' : 'prompts');
            }).catch(e => alert("éŒ¯èª¤: " + e.message));
        }

        function editApp(app) {
            showPage('upload');
            document.getElementById('editModeId').value = app.id;
            document.getElementById('uploadType').value = 'app';
            toggleUploadForm();
            document.getElementById('appTitle').value = app.title;
            document.getElementById('appCategory').value = app.category;
            handleCategoryChange();
            document.getElementById('appSubject').value = app.subject || "";
            document.getElementById('appAdminType').value = app.adminType || "";
            document.getElementById('appLink').value = app.link;
            document.getElementById('appPainPoint').value = app.painPoint;
            document.getElementById('appDesc').value = app.desc;
            document.getElementById('appTags').value = Array.isArray(app.tags) ? app.tags.join(", ") : app.tags;
            
            const btn = document.getElementById('submitBtn');
            btn.innerText = "ç¢ºèªæ›´æ–°";
            btn.classList.replace('btn-primary', 'btn-success');
            document.getElementById('cancelBtn').style.display = 'block';
        }

        function resetForm() {
            document.getElementById('editModeId').value = "";
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('appTags').value = "General";
            const btn = document.getElementById('submitBtn');
            btn.innerText = "ç¢ºèªç™¼å¸ƒ";
            btn.classList.replace('btn-success', 'btn-primary');
            document.getElementById('cancelBtn').style.display = 'none';
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function exportDataReport() {
            db.collection('apps').get().then(snap => {
                let csv = "data:text/csv;charset=utf-8,\uFEFFID,Title,Category,Subject/Type,Author,PainPoint\n";
                snap.forEach(doc => {
                    const d = doc.data();
                    const sub = d.category==='teaching' ? d.subject : d.adminType;
                    csv += `${doc.id},${d.title},${d.category},${sub},${d.author},"${d.painPoint}"\n`;
                });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csv));
                link.setAttribute("download", "BCK_Report.csv");
                document.body.appendChild(link);
                link.click();
            });
        }
    </script>
</body>
</html>