<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hub | V4.6 Full Feature</title>
    
    <link rel="icon" href="https://img.icons8.com/fluency/96/artificial-intelligence.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        /* CSS æ¨£å¼å€åŸŸ */
        :root {
            --primary: #2c3e50;
            --accent: #00d2ff;
            --accent-dark: #3a7bd5; 
            --light: #ecf0f1;
            --success: #00b09b;
            --warning: #f39c12;
            --danger: #e74c3c;
            --admin-color: #8e44ad;
            --value-edu-color: #e91e63;
            --forum-color: #6c5ce7;
            --terminal-bg: #1e1e1e;
            --terminal-text: #00ff00;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f4f7f6; display: flex; height: 100vh; overflow-x: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: linear-gradient(135deg, #141e30 0%, #243b55 100%); color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 1001; flex-shrink: 0; white-space: nowrap; transition: all 0.3s; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; width: 100%; }
        .sidebar-header { text-align: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; }
        .app-name { font-size: 1.4rem; margin: 0; font-weight: bold; background: -webkit-linear-gradient(#00d2ff, #3a7bd5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .menu-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; }
        .menu-item:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
        .menu-item.active { background: rgba(255,255,255,0.15); border-left: 4px solid var(--accent); }
        .menu-icon { margin-right: 10px; width: 20px; text-align: center; }
        .user-info { margin-top: auto; padding-top:20px; border-top:1px solid rgba(255,255,255,0.2); font-size: 0.9rem; }
        
        /* Mobile */
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); width: 260px; }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .main-content { padding: 15px; }
        }

        /* General UI */
        .page { display: none; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: linear-gradient(135deg, #3a7bd5, #00d2ff); color: white; }
        .btn-forum { background-color: var(--forum-color); color: white; }
        .btn-outline { border: 1px solid #ccc; background: white; color: #555; }
        .btn-xs { padding: 4px 8px; font-size: 0.8rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; }

        /* DASHBOARD V4.6 */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid var(--accent-dark); }
        .stat-number { font-size: 2.5rem; font-weight: 800; color: var(--primary); margin: 10px 0; }
        
        .charts-container { display: flex; flex-direction: column; gap: 30px; }
        .chart-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .chart-box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-height: 400px; display:flex; flex-direction:column; }
        
        /* Leaderboards */
        .leaderboard-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 30px; }
        .leaderboard-box { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .leaderboard-table { width: 100%; border-collapse: collapse; }
        .leaderboard-table th { text-align: left; padding: 10px; border-bottom: 2px solid #eee; color: #7f8c8d; font-size: 0.9rem; }
        .leaderboard-table td { padding: 12px 10px; border-bottom: 1px solid #f5f5f5; font-size: 0.95rem; }
        .rank-badge { background: #eee; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; color: #555; }
        .rank-1 { background: #ffd700; color: #d35400; }
        .rank-2 { background: #C0C0C0; color: #555; }
        .rank-3 { background: #cd7f32; color: #fff; }

        /* PROMPTS V4.6 (Black/Green) */
        .prompt-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .prompt-content-box { 
            background: var(--terminal-bg); 
            color: var(--terminal-text); 
            padding: 15px; 
            font-family: 'Courier New', Courier, monospace; 
            font-size: 0.95rem; 
            border-radius: 6px; 
            margin-bottom: 15px; 
            border: 1px solid #333; 
            white-space: pre-wrap; 
            max-height: 250px; 
            overflow-y: auto;
            position: relative;
        }
        .prompt-content-box::before { content: ">_"; position: absolute; top: 15px; left: 10px; opacity: 0.5; }
        .prompt-content-box { padding-left: 35px; }

        /* RESOURCE CARDS V4.6 */
        .resource-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.2s; overflow: hidden; display: flex; flex-direction: column; border: 1px solid #eee; cursor: pointer; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.1); }
        
        .card-preview-area { width: 100%; height: 160px; position: relative; overflow: hidden; background: #f0f0f0; border-bottom: 1px solid #eee; }
        .card-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .card:hover .card-img { transform: scale(1.05); }
        
        .card-content { padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .card-title { margin: 0 0 5px 0; font-size: 1.15rem; color: #2c3e50; font-weight: 700; }
        
        .tag-row { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 5px; }
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; background: #eee; color: #555; }
        .tag-5c { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        
        .card-rating-mini { font-size: 0.8rem; color: #f39c12; margin-top: auto; display: flex; align-items: center; gap: 5px; font-weight: bold; }

        /* APP DETAIL MODAL (V3.5 Style) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-container { background: white; width: 90%; max-width: 900px; height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; animation: slideUp 0.3s; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; display: grid; grid-template-columns: 3fr 2fr; gap: 30px; }
        @media(max-width:768px){ .modal-body { grid-template-columns: 1fr; } }
        
        .rating-section { background: #f9f9f9; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .star-input span { cursor: pointer; font-size: 1.5rem; color: #ccc; transition: 0.2s; }
        .star-input span.active { color: #f39c12; }
        .star-input:hover span { color: #f39c12; }
        .comment-box { margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .comment-item { margin-bottom: 10px; font-size: 0.9rem; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        /* 5C Checkbox Grid */
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-top: 5px; }
        .checkbox-item { display: flex; align-items: center; font-size: 0.9rem; background: #fff; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .checkbox-item input { margin-right: 8px; }
    </style>
</head>
<body>

    <div id="loginModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(20,30,48,0.95); display:flex; justify-content:center; align-items:center; z-index:3000;">
        <div style="background:white; padding:40px; border-radius:15px; width:340px; text-align:center;">
            <h2 style="color:var(--primary);">BCK-AI Hub V4.6</h2>
            <p style="color:#7f8c8d;">æ ¡æ–¹å¸³è™Ÿæˆ–è¨ªå®¢ç™»å…¥</p>
            <input type="email" id="loginEmail" class="form-control" placeholder="Email">
            <input type="password" id="loginPass" class="form-control" placeholder="Password">
            <button id="loginBtn" class="btn btn-primary" style="width:100%" onclick="handleLogin()">ç™»å…¥ç³»çµ±</button>
            <p id="loginMsg" style="color:red; font-size:0.9rem; margin-top:10px;"></p>
        </div>
    </div>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar">
        <div class="sidebar-header">
            <div style="font-size:0.85rem; opacity:0.8;">é¦™æµ·æ­£è¦ºè“®ç¤¾<br>ä½›æ•™æ­£è¦ºè“®ç¤¾å­¸æ ¡</div>
            <h2 class="app-name">BCK-AI Hub</h2>
            <div style="font-size:0.7rem; background:rgba(255,255,255,0.1); border-radius:10px; display:inline-block; padding:2px 8px; margin-top:5px;">V4.6 Ultimate</div>
        </div>
        <div id="menu-dashboard" class="menu-item active" onclick="showPage('dashboard')"><span class="menu-icon">ğŸ“Š</span> æ•¸æ“šç¸½è¦½</div>
        <div id="menu-apps" class="menu-item" onclick="showPage('apps')"><span class="menu-icon">ğŸ“±</span> è³‡æºå±•ç¤ºåº«</div>
        <div id="menu-prompts" class="menu-item" onclick="showPage('prompts')"><span class="menu-icon">ğŸ’¡</span> å¥½Prompt åˆ†äº«</div>
        <div id="menu-forum" class="menu-item" onclick="showPage('forum')"><span class="menu-icon">ğŸ’¬</span> æ•™å¸«è¨è«–å€</div>
        <div id="menu-upload" class="menu-item" onclick="showPage('upload')"><span class="menu-icon">ğŸ“¤</span> ä¸Šè¼‰åˆ†äº«</div>
        <div class="user-info">
            <p>ğŸ‘‹ <span id="currentUserDisplay">...</span></p>
            <button class="btn btn-outline btn-xs" style="width:100%; border-color:rgba(255,255,255,0.3); color:white; background:transparent;" onclick="logout()">ç™»å‡º</button>
        </div>
    </div>

    <div class="main-content">
        <div style="display:flex; align-items:center; margin-bottom:20px;">
            <button class="btn" onclick="toggleSidebar()" style="font-size:1.5rem; padding:0 10px; margin-right:10px;">â˜°</button>
            <h2 style="margin:0; color:var(--primary);">BCK-AI Hub</h2>
        </div>

        <div id="dashboard" class="page active">
            <h1 style="margin-bottom:20px;">å¹³å°æ•¸æ“šå„€è¡¨æ¿</h1>
            
            <div class="stats-grid">
                <div class="stat-card" style="border-bottom-color: var(--accent-dark);"><div class="stat-number" id="totalApps">0</div><div>å­¸æ•™è©•è³‡æº</div></div>
                <div class="stat-card" style="border-bottom-color: var(--warning);"><div class="stat-number" id="totalPrompts">0</div><div>Prompt æŒ‡ä»¤</div></div>
                <div class="stat-card" style="border-bottom-color: var(--success);"><div class="stat-number" id="activeTeachers">0</div><div>åƒèˆ‡è€å¸«</div></div>
            </div>

            <div class="charts-container">
                <div class="chart-row">
                    <div class="chart-box">
                        <h3 style="color:var(--accent-dark); margin-top:0;">ğŸ“ å­¸ç§‘åˆ†ä½ˆ</h3>
                        <div style="flex:1;"><canvas id="subjectChart"></canvas></div>
                    </div>
                    <div class="chart-box">
                        <h3 style="color:var(--admin-color); margin-top:0;">ğŸ“‚ è¡Œæ”¿åˆ†é¡</h3>
                        <div style="flex:1;"><canvas id="adminChart"></canvas></div>
                    </div>
                </div>
                <div class="chart-box">
                    <h3 style="color:#2ecc71; margin-top:0;">ğŸŒŸ 5C+ ç´ é¤Šåˆ†ä½ˆ (V3.5 Feature)</h3>
                    <div style="flex:1; max-height:350px;"><canvas id="fiveCChart"></canvas></div>
                </div>
            </div>

            <div class="leaderboard-section">
                <div class="leaderboard-box">
                    <h3 style="margin-top:0; color:#d35400;">ğŸ† æ´»èºè²¢ç»æ’è¡Œæ¦œ</h3>
                    <table class="leaderboard-table" id="contributorTable">
                        <thead><tr><th>æ’å</th><th>è€å¸«</th><th>è²¢ç»æ•¸é‡</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="leaderboard-box">
                    <h3 style="margin-top:0; color:#f1c40f;">â­ å„ªè³ªä½œå“æ’è¡Œæ¦œ (Top Rated)</h3>
                    <table class="leaderboard-table" id="topRatedTable">
                        <thead><tr><th>æ’å</th><th>ä½œå“åç¨±</th><th>è©•åˆ†</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="apps" class="page">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h1>è³‡æºå±•ç¤ºåº«</h1>
                <div>
                    <button class="btn btn-all" onclick="filterApps('all')">å…¨éƒ¨</button>
                    <button class="btn btn-primary" onclick="filterApps('teaching')">å­¸æ•™è©•</button>
                    <button class="btn btn-value" onclick="filterApps('value')">ğŸ’— åƒ¹å€¼è§€</button>
                    <button class="btn btn-admin" onclick="filterApps('admin')">è¡Œæ”¿</button>
                </div>
            </div>
            <div id="appsContainer" class="resource-grid"></div>
        </div>

        <div id="prompts" class="page">
            <h1>å¥½ Prompt åˆ†äº«å€</h1>
            <div id="promptsContainer" class="resource-grid" style="grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));"></div>
        </div>

        <div id="forum" class="page">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h1>ğŸ’¬ æ•™å¸«è¨è«–å€</h1>
                <button class="btn btn-forum" id="newPostBtn" onclick="openNewPostModal()">â• ç™¼èµ·è¨è«–</button>
            </div>
            <div id="forumContainer"></div>
        </div>

        <div id="upload" class="page">
            <h1>ä¸Šè¼‰ / ç·¨è¼¯è³‡æº</h1>
            <div style="background:white; padding:30px; border-radius:12px; max-width:800px; margin:0 auto;">
                <div class="form-group">
                    <label>è³‡æºé¡å‹</label>
                    <select id="uploadType" class="form-control" onchange="toggleUploadForm()"><option value="app">ä¸Šè¼‰ä½œå“</option><option value="prompt">ç´”åˆ†äº« AI Prompt</option></select>
                </div>
                <div id="appForm">
                    <div class="form-group"><label>ä½œå“åç¨±</label><input type="text" id="appTitle" class="form-control"></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div class="form-group"><label>åˆ†é¡</label><select id="appCategory" class="form-control" onchange="handleCatChange()"><option value="teaching">å­¸æ•™è©•</option><option value="admin">è¡Œæ”¿</option></select></div>
                        <div class="form-group" id="subjGroup"><label>ç§‘ç›®</label><select id="appSubject" class="form-control"><option>ä¸­æ–‡</option><option>è‹±æ–‡</option><option>æ•¸å­¸</option><option>å¸¸è­˜/ç§‘å­¸</option><option>äººæ–‡</option><option>è¦–è—</option><option>éŸ³æ¨‚</option><option>é«”è‚²</option><option>åœ–æ›¸</option><option>æ™®é€šè©±</option><option>ä½›å­¸</option><option>ç§‘æŠ€</option><option>åƒ¹å€¼è§€æ•™è‚²</option><option>è·¨èª²ç¨‹</option></select></div>
                        <div class="form-group" id="admGroup" style="display:none;"><label>è¡Œæ”¿é¡åˆ¥</label><select id="appAdminType" class="form-control"><option>æ ¡å‹™é‹ä½œ</option><option>æ–‡æ›¸è™•ç†</option><option>æ•¸æ“šåˆ†æ</option><option>è³‡è¨Šé€šè¨Š</option><option>æ´»å‹•ç­–åŠƒ</option><option>è³‡æºç®¡ç†</option></select></div>
                    </div>
                    
                    <div class="form-group" id="5cGroup">
                        <label>ğŸŒŸ 5C+ æ ¸å¿ƒç´ é¤Š (å¯å¤šé¸)</label>
                        <div class="checkbox-grid">
                            <label class="checkbox-item"><input type="checkbox" name="5c" value="Creativity"> Creativity (å‰µæ„)</label>
                            <label class="checkbox-item"><input type="checkbox" name="5c" value="Critical Thinking"> Critical Thinking (æ…æ€æ˜è¾¨)</label>
                            <label class="checkbox-item"><input type="checkbox" name="5c" value="Communication"> Communication (æºé€š)</label>
                            <label class="checkbox-item"><input type="checkbox" name="5c" value="Collaboration"> Collaboration (å”ä½œ)</label>
                            <label class="checkbox-item"><input type="checkbox" name="5c" value="Citizenship"> Citizenship (å…¬æ°‘ç´ é¤Š)</label>
                            <label class="checkbox-item"><input type="checkbox" name="5c" value="Character"> Character (å“æ ¼)</label>
                        </div>
                    </div>

                    <div class="form-group"><label>æª”æ¡ˆé¡å‹</label><select id="resourceType" class="form-control" onchange="handleResType()"><option value="url">ç¶²é é€£çµ (URL)</option><option value="image">åœ–ç‰‡ (Image)</option><option value="video">å½±ç‰‡</option><option value="presentation">ç°¡å ±</option><option value="worksheet">å·¥ä½œç´™</option></select></div>
                    <div class="form-group" id="urlGroup"><label>é€£çµ</label><input type="text" id="appLink" class="form-control"></div>
                    <div class="form-group" id="fileGroup" style="display:none;"><label>ä¸Šå‚³é è¦½åœ–/æ–‡ä»¶åœ–ç‰‡</label><input type="file" id="appFile" class="form-control" accept="image/*"><input type="hidden" id="appFileBase64"></div>
                    <div class="form-group"><label>è§£æ±ºäº†ä»€éº¼é›£é»ï¼Ÿ</label><input type="text" id="appPainPoint" class="form-control"></div>
                </div>
                
                <div id="promptForm" style="display:none;">
                    <div class="form-group"><label>ä¸»é¡Œ</label><input type="text" id="promptTitle" class="form-control"></div>
                    <div class="form-group"><label>å…§å®¹ (å°‡ä»¥é»‘åº•ç¶ å­—é¡¯ç¤º)</label><textarea id="promptContent" class="form-control" rows="8"></textarea></div>
                    <div class="form-group"><label>ç”¨é€”</label><input type="text" id="promptPurpose" class="form-control"></div>
                </div>
                <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="submitUpload()">ç¢ºèªç™¼å¸ƒ</button>
            </div>
        </div>
    </div>

    <div id="appDetailModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="modalAppTitle" style="margin:0;"></h2>
                <button class="btn btn-outline btn-round" onclick="document.getElementById('appDetailModal').style.display='none'">âœ•</button>
            </div>
            <div class="modal-body">
                <div>
                    <div id="modalAppPreview" style="width:100%; height:200px; background:#eee; border-radius:8px; margin-bottom:15px; overflow:hidden; display:flex; align-items:center; justify-content:center;"></div>
                    <div style="margin-bottom:15px;">
                        <span class="tag" id="modalAppAuthor"></span>
                        <span class="tag" id="modalAppDate"></span>
                    </div>
                    <p id="modalAppDesc" style="color:#555; line-height:1.6;"></p>
                    <div id="modalAppTags" class="tag-row" style="margin-bottom:20px;"></div>
                    <a id="modalAppLink" href="#" target="_blank" class="btn btn-primary" style="width:100%; padding:15px; font-size:1.1rem;">ğŸš€ é–‹å•Ÿè³‡æºé€£çµ</a>
                </div>
                
                <div>
                    <div class="rating-section">
                        <h4 style="margin-top:0;">ğŸ“Š è©•åˆ† (V3.5 Feature)</h4>
                        <div style="margin-bottom:10px;">
                            <label>æ˜“ç”¨åº¦ (Usability): <span id="usabilityVal">0</span>/5</label>
                            <div class="star-input" id="starUsability">
                                <span onclick="rate(1,'u')">â˜…</span><span onclick="rate(2,'u')">â˜…</span><span onclick="rate(3,'u')">â˜…</span><span onclick="rate(4,'u')">â˜…</span><span onclick="rate(5,'u')">â˜…</span>
                            </div>
                        </div>
                        <div>
                            <label>æˆæ•ˆ (Effectiveness): <span id="effectiveVal">0</span>/5</label>
                            <div class="star-input" id="starEffective">
                                <span onclick="rate(1,'e')">â˜…</span><span onclick="rate(2,'e')">â˜…</span><span onclick="rate(3,'e')">â˜…</span><span onclick="rate(4,'e')">â˜…</span><span onclick="rate(5,'e')">â˜…</span>
                            </div>
                        </div>
                        <button class="btn btn-success btn-xs" style="margin-top:10px; width:100%" onclick="submitRating()">é€å‡ºè©•åˆ†</button>
                    </div>

                    <div class="comment-box">
                        <h4 style="margin:0 0 10px 0;">ğŸ’¬ åŒäº‹ç•™è¨€</h4>
                        <div id="commentList" style="max-height:200px; overflow-y:auto; margin-bottom:10px;"></div>
                        <textarea id="newComment" class="form-control" rows="2" placeholder="å¯«ä¸‹ä½ çš„çœ‹æ³•..."></textarea>
                        <button class="btn btn-primary btn-xs" onclick="submitComment()">ç•™è¨€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="forumModal" class="modal-overlay">
        <div class="modal-container" style="max-width:600px; height:auto; max-height:80vh;">
            <div style="padding:20px; border-bottom:1px solid #eee;">
                <h3 id="forumTitle" style="margin:0;"></h3>
                <button style="float:right; margin-top:-25px;" class="btn btn-outline btn-xs" onclick="document.getElementById('forumModal').style.display='none'">âœ•</button>
            </div>
            <div style="padding:20px; overflow-y:auto;" id="forumContent"></div>
            <div style="padding:20px; background:#f9f9f9;">
                <textarea id="forumReply" class="form-control" rows="2"></textarea>
                <button class="btn btn-forum" onclick="submitForumReply()">å›è¦†</button>
            </div>
        </div>
    </div>

    <div id="newPostOverlay" class="modal-overlay">
        <div class="modal-container" style="max-width:600px; height:auto; padding:20px;">
            <h3>ç™¼èµ·æ–°è¨è«–</h3>
            <input id="postTitle" class="form-control" placeholder="æ¨™é¡Œ">
            <textarea id="postContent" class="form-control" rows="4" placeholder="å…§å®¹"></textarea>
            <div style="text-align:right; margin-top:10px;">
                <button class="btn btn-outline" onclick="document.getElementById('newPostOverlay').style.display='none'">å–æ¶ˆ</button>
                <button class="btn btn-forum" onclick="submitPost()">ç™¼å¸ƒ</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const firebaseConfig = { apiKey: "AIzaSyBPRN5_vnvMOPAR0fTVaZoqM57ffIGZOQU", authDomain: "bck-ai-hub.firebaseapp.com", projectId: "bck-ai-hub", storageBucket: "bck-ai-hub.firebasestorage.app", messagingSenderId: "1010987556331", appId: "1:1010987556331:web:07dac81847056ae7520dae" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentUser = null;
        let currentAppId = null; 
        let currentForumId = null;
        let currentRating = { u:0, e:0 };
        const teacherDirectory = { "lwysams@bcklas.edu.hk": "ç©", "slssams@bcklas.edu.hk": "çŠ" }; // Simplified for demo
        const guestPass = "26754411!";

        // --- Auth ---
        auth.onAuthStateChanged(u => {
            if(u){ 
                currentUser = { name: teacherDirectory[u.email]||u.email.split('@')[0], email: u.email, uid: u.uid };
                document.getElementById('loginModal').style.display='none'; initApp();
            } else if(!currentUser?.isGuest) {
                document.getElementById('loginModal').style.display='flex';
            }
        });
        function handleLogin(){
            const e=document.getElementById('loginEmail').value, p=document.getElementById('loginPass').value;
            if(p===guestPass){ currentUser={name:"è¨ªå®¢",isGuest:true}; document.getElementById('loginModal').style.display='none'; initApp(); return; }
            auth.signInWithEmailAndPassword(e,p).catch(err=>document.getElementById('loginMsg').innerText=err.message);
        }
        function logout(){ auth.signOut().then(()=>location.reload()); }

        // --- Core Logic ---
        function initApp(){
            document.getElementById('currentUserDisplay').innerText = currentUser.name;
            if(currentUser.isGuest) document.getElementById('newPostBtn').style.display='none';
            loadData();
        }

        async function loadData(){
            const apps = (await db.collection('apps').orderBy('timestamp','desc').get()).docs.map(d=>({id:d.id,...d.data()}));
            const prompts = (await db.collection('prompts').orderBy('timestamp','desc').get()).docs.map(d=>({id:d.id,...d.data()}));
            const posts = (await db.collection('posts').orderBy('timestamp','desc').get()).docs.map(d=>({id:d.id,...d.data()}));
            renderApps(apps); renderPrompts(prompts); renderForum(posts); renderDashboard(apps,prompts);
        }

        // --- Dashboard V4.6 (Charts + Leaderboards) ---
        function renderDashboard(apps, prompts){
            document.getElementById('totalApps').innerText = apps.filter(a=>a.category==='teaching').length;
            document.getElementById('totalPrompts').innerText = prompts.length;
            document.getElementById('activeTeachers').innerText = new Set([...apps.map(a=>a.author), ...prompts.map(p=>p.author)]).size;

            // 1. Subject Chart (Bar)
            const subC = {}; apps.filter(a=>a.category==='teaching').forEach(a=>subC[a.subject||'å…¶ä»–']=(subC[a.subject||'å…¶ä»–']||0)+1);
            new Chart(document.getElementById('subjectChart'), {type:'bar', data:{labels:Object.keys(subC), datasets:[{data:Object.values(subC), backgroundColor:['#e74c3c','#e67e22','#f1c40f','#e91e63']}]}, options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
            
            // 2. Admin Chart (Doughnut)
            const admC = {}; apps.filter(a=>a.category==='admin').forEach(a=>admC[a.adminType||'å…¶ä»–']=(admC[a.adminType||'å…¶ä»–']||0)+1);
            new Chart(document.getElementById('adminChart'), {type:'doughnut', data:{labels:Object.keys(admC), datasets:[{data:Object.values(admC), backgroundColor:['#3498db','#9b59b6','#1abc9c']}]}});

            // 3. 5C Chart (Radar) - New for V4.6
            const fiveC = {Creativity:0, 'Critical Thinking':0, Communication:0, Collaboration:0, Citizenship:0, Character:0};
            apps.forEach(a => { if(a.fiveC) a.fiveC.forEach(c => { if(fiveC[c]!==undefined) fiveC[c]++; }); });
            new Chart(document.getElementById('fiveCChart'), {
                type: 'radar',
                data: {
                    labels: Object.keys(fiveC),
                    datasets: [{ label: 'ç´ é¤Šåˆ†ä½ˆ', data: Object.values(fiveC), backgroundColor: 'rgba(46, 204, 113, 0.4)', borderColor: '#2ecc71', borderWidth: 2 }]
                },
                options: { scales: { r: { beginAtZero: true, ticks: { display: false } } } }
            });

            // 4. Leaderboards - New for V4.6
            // Active Contributors
            const authors = {}; 
            [...apps, ...prompts].forEach(x => authors[x.author] = (authors[x.author]||0) + 1);
            const topAuthors = Object.entries(authors).sort((a,b)=>b[1]-a[1]).slice(0,5);
            document.querySelector('#contributorTable tbody').innerHTML = topAuthors.map((a,i)=>`<tr><td><span class="rank-badge rank-${i+1}">${i+1}</span></td><td>${a[0]}</td><td>${a[1]}</td></tr>`).join('');

            // Top Rated (Mock Calculation: Avg of usablity + effectiveness)
            const ratedApps = apps.map(a => {
                const ratings = Object.values(a.ratings || {});
                if(ratings.length === 0) return { title: a.title, score: 0 };
                const sum = ratings.reduce((acc, r) => acc + (r.u + r.e)/2, 0);
                return { title: a.title, score: (sum / ratings.length).toFixed(1) };
            }).sort((a,b) => b.score - a.score).slice(0,5);
            document.querySelector('#topRatedTable tbody').innerHTML = ratedApps.map((a,i)=>`<tr><td><span class="rank-badge rank-${i+1}">${i+1}</span></td><td>${a.title}</td><td>â­ ${a.score}</td></tr>`).join('');
        }

        // --- Render Resources (V4.6: Previews & Tags) ---
        function renderApps(apps){
            const c = document.getElementById('appsContainer'); c.innerHTML='';
            apps.forEach(app => {
                // Determine Preview Image
                let imgHTML = '';
                if(app.resourceType === 'image' && app.link && app.link.startsWith('data:image')) {
                    imgHTML = `<img src="${app.link}" class="card-img">`;
                } else {
                    const icon = app.resourceType==='worksheet'?'ğŸ“„':app.resourceType==='presentation'?'ğŸ“Š':app.resourceType==='video'?'ğŸ¬':'ğŸ”—';
                    imgHTML = `<div class="card-placeholder" style="background:linear-gradient(135deg,#3498db,#2c3e50);"><div class="ph-icon">${icon}</div></div>`;
                }
                
                // 5C Tags
                let tagsHTML = `<span class="tag">${app.subject||app.adminType}</span>`;
                if(app.fiveC) app.fiveC.forEach(tag => tagsHTML += `<span class="tag tag-5c">${tag}</span>`);

                // Avg Rating
                const ratings = Object.values(app.ratings || {});
                const score = ratings.length ? (ratings.reduce((s,r)=>s+(r.u+r.e)/2,0)/ratings.length).toFixed(1) : 'New';

                c.innerHTML += `
                <div class="card" data-cat="${app.category}" data-sub="${app.subject}" onclick="openAppDetail('${app.id}')">
                    <div class="card-preview-area">${imgHTML}</div>
                    <div class="card-content">
                        <h3 class="card-title">${app.title}</h3>
                        <div class="card-meta"><span>${app.author}</span><span>â­ ${score}</span></div>
                        <div class="tag-row">${tagsHTML}</div>
                        <div class="card-desc">${app.painPoint||'æš«ç„¡æè¿°'}</div>
                    </div>
                </div>`;
            });
        }

        // --- App Detail Modal (V3.5 Logic) ---
        async function openAppDetail(id){
            currentAppId = id;
            const app = (await db.collection('apps').doc(id).get()).data();
            
            document.getElementById('modalAppTitle').innerText = app.title;
            document.getElementById('modalAppAuthor').innerText = app.author;
            document.getElementById('modalAppDate').innerText = new Date(app.timestamp).toLocaleDateString();
            document.getElementById('modalAppDesc').innerText = app.painPoint || "æ²’æœ‰æè¿°";
            document.getElementById('modalAppLink').href = app.link;
            
            // Preview in Modal
            const previewBox = document.getElementById('modalAppPreview');
            if(app.resourceType === 'image' && app.link.startsWith('data:image')){
                previewBox.innerHTML = `<img src="${app.link}" style="width:100%; height:100%; object-fit:contain;">`;
            } else {
                previewBox.innerHTML = `<div style="font-size:3rem;">ğŸ”—</div>`;
            }

            // Tags
            let tags = `<span class="tag">${app.subject||app.adminType}</span>`;
            if(app.fiveC) app.fiveC.forEach(t => tags += `<span class="tag tag-5c">${t}</span>`);
            document.getElementById('modalAppTags').innerHTML = tags;

            // Load Comments
            const cList = document.getElementById('commentList'); cList.innerHTML = '';
            if(app.comments) app.comments.forEach(c => {
                cList.innerHTML += `<div class="comment-item"><strong>${c.author}</strong>: ${c.content} <span style="color:#aaa;font-size:0.8rem">${new Date(c.timestamp).toLocaleDateString()}</span></div>`;
            });

            // Reset Rating UI
            currentRating = {u:0, e:0}; updateStarUI('u',0); updateStarUI('e',0);
            
            document.getElementById('appDetailModal').style.display = 'flex';
        }

        // Rating Logic
        function rate(val, type){
            currentRating[type] = val;
            updateStarUI(type, val);
        }
        function updateStarUI(type, val){
            const spans = document.getElementById(type==='u'?'starUsability':'starEffective').children;
            for(let i=0; i<5; i++) spans[i].className = i<val ? 'active' : '';
            document.getElementById(type==='u'?'usabilityVal':'effectiveVal').innerText = val;
        }
        async function submitRating(){
            if(currentUser.isGuest) return alert('è¨ªå®¢ä¸èƒ½è©•åˆ†');
            if(currentRating.u===0 || currentRating.e===0) return alert('è«‹å¡«å¯«å…©é …è©•åˆ†');
            const ratingKey = `ratings.${currentUser.uid}`;
            await db.collection('apps').doc(currentAppId).update({
                [ratingKey]: { u: currentRating.u, e: currentRating.e, timestamp: Date.now() }
            });
            alert('è©•åˆ†å·²é€å‡ºï¼'); loadData();
        }
        async function submitComment(){
            if(currentUser.isGuest) return alert('è¨ªå®¢ä¸èƒ½ç•™è¨€');
            const txt = document.getElementById('newComment').value;
            if(!txt) return;
            await db.collection('apps').doc(currentAppId).update({
                comments: firebase.firestore.FieldValue.arrayUnion({ author: currentUser.name, content: txt, timestamp: Date.now() })
            });
            document.getElementById('newComment').value='';
            openAppDetail(currentAppId); // Reload modal
        }

        // --- Prompts V4.6 (Black/Green) ---
        function renderPrompts(prompts){
            const c = document.getElementById('promptsContainer'); c.innerHTML='';
            prompts.forEach(p => {
                c.innerHTML += `
                <div class="prompt-card">
                    <h3 style="margin-top:0;">${p.title}</h3>
                    <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">By ${p.author} â€¢ ${p.purpose||'é€šç”¨'}</div>
                    <div class="prompt-content-box">${p.content}</div>
                    <button class="btn btn-outline btn-xs" onclick="navigator.clipboard.writeText(\`${p.content.replace(/`/g,'\\`')}\`);alert('Copied!')">ğŸ“‹ Copy Code</button>
                </div>`;
            });
        }

        // --- Other Funcs ---
        function showPage(id){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active')); document.getElementById('menu-'+id).classList.add('active'); if(window.innerWidth<=768) toggleSidebar(); }
        function toggleSidebar(){ document.querySelector('.sidebar').classList.toggle('active'); document.querySelector('.sidebar-overlay').classList.toggle('active'); }
        function filterApps(t){ document.querySelectorAll('#appsContainer .card').forEach(c=>c.style.display=(t==='all'||c.dataset.cat===t||(t==='value'&&c.dataset.sub==='åƒ¹å€¼è§€æ•™è‚²'))?'flex':'none'); }
        
        // Upload Logic
        function toggleUploadForm(){ const t=document.getElementById('uploadType').value; document.getElementById('appForm').style.display=t==='app'?'block':'none'; document.getElementById('promptForm').style.display=t==='prompt'?'block':'none'; }
        function handleCatChange(){ const adm=document.getElementById('appCategory').value==='admin'; document.getElementById('admGroup').style.display=adm?'block':'none'; document.getElementById('subjGroup').style.display=adm?'none':'block'; document.getElementById('5cGroup').style.display=adm?'none':'block'; }
        function handleResType(){ const t=document.getElementById('resourceType').value; document.getElementById('fileGroup').style.display=t==='image'?'block':'none'; document.getElementById('urlGroup').style.display=t==='image'?'none':'block'; }
        document.getElementById('appFile').addEventListener('change', e=>{ const r=new FileReader(); r.readAsDataURL(e.target.files[0]); r.onload=()=>document.getElementById('appFileBase64').value=r.result; });

        async function submitUpload(){
            if(!currentUser) return;
            const type = document.getElementById('uploadType').value;
            const base = { author: currentUser.name, uid: currentUser.uid, timestamp: Date.now() };
            
            if(type === 'app'){
                // Collect 5C
                const fiveC = [];
                document.querySelectorAll('input[name="5c"]:checked').forEach(cb => fiveC.push(cb.value));
                
                const data = {
                    ...base,
                    title: document.getElementById('appTitle').value,
                    category: document.getElementById('appCategory').value,
                    subject: document.getElementById('appSubject').value,
                    adminType: document.getElementById('appAdminType').value,
                    fiveC: fiveC,
                    resourceType: document.getElementById('resourceType').value,
                    link: document.getElementById('resourceType').value==='image' ? document.getElementById('appFileBase64').value : document.getElementById('appLink').value,
                    painPoint: document.getElementById('appPainPoint').value,
                    ratings: {},
                    comments: []
                };
                await db.collection('apps').add(data);
                alert('è³‡æºç™¼å¸ƒæˆåŠŸï¼'); showPage('apps'); loadData();
            } else {
                const data = { ...base, title: document.getElementById('promptTitle').value, content: document.getElementById('promptContent').value, purpose: document.getElementById('promptPurpose').value };
                await db.collection('prompts').add(data);
                alert('Prompt åˆ†äº«æˆåŠŸï¼'); showPage('prompts'); loadData();
            }
        }
        
        // Forum Minimal Logic
        async function openNewPostModal(){ document.getElementById('newPostOverlay').style.display='flex'; }
        async function submitPost(){ await db.collection('posts').add({ title:document.getElementById('postTitle').value, content:document.getElementById('postContent').value, author:currentUser.name, replies:[], timestamp:Date.now() }); document.getElementById('newPostOverlay').style.display='none'; loadData(); }
        function renderForum(posts){ document.getElementById('forumContainer').innerHTML = posts.map(p=>`<div class="forum-post" style="background:white;padding:15px;margin-bottom:10px;border-radius:8px;border:1px solid #eee;cursor:pointer;" onclick="openForumDetail('${p.id}')"><h4>${p.title}</h4><p style="color:#666;font-size:0.9rem">${p.content.substring(0,50)}...</p></div>`).join(''); }
        async function openForumDetail(id){ currentForumId=id; const p=(await db.collection('posts').doc(id).get()).data(); document.getElementById('forumTitle').innerText=p.title; document.getElementById('forumContent').innerHTML=`<p>${p.content}</p><hr>`+(p.replies||[]).map(r=>`<p><b>${r.author}:</b> ${r.content}</p>`).join(''); document.getElementById('forumModal').style.display='flex'; }
        async function submitForumReply(){ const t=document.getElementById('forumReply').value; if(t) await db.collection('posts').doc(currentForumId).update({replies:firebase.firestore.FieldValue.arrayUnion({author:currentUser.name,content:t})}); document.getElementById('forumReply').value=''; openForumDetail(currentForumId); }

    </script>
</body>
</html>