<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hub | è³‡æºå±•ç¤ºåº« V3.7</title>
    
    <link rel="icon" href="https://img.icons8.com/fluency/96/artificial-intelligence.png" type="image/png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #00d2ff;
            --accent-dark: #3a7bd5;
            --light: #ecf0f1;
            --success: #00b09b;
            --warning: #f39c12;
            --danger: #e74c3c;
            --admin-color: #8e44ad;
            --value-edu-color: #e91e63;
            --gold: #f1c40f;
            --silver: #95a5a6;
            --bronze: #cd7f32;
            --all-btn-color: #5d6d7e;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f4f7f6; display: flex; height: 100vh; overflow-x: hidden; }
        
        .sidebar { 
            width: 260px; 
            background: linear-gradient(135deg, #141e30 0%, #243b55 100%);
            color: white; 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.1); 
            transition: all 0.3s ease-in-out; 
            z-index: 1001; 
            flex-shrink: 0;
            white-space: nowrap;
        }

        body.desktop-collapsed .sidebar { margin-left: -300px; }
        
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; width: 100%; transition: margin 0.3s; }
        
        .page { display: none; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .header-bar { display: flex; align-items: center; margin-bottom: 20px; }
        .menu-toggle-btn { 
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--primary); padding: 5px 15px 5px 0; outline: none;
        }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }

        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); width: 260px; }
            .sidebar.active { transform: translateX(0); }
            body.desktop-collapsed .sidebar { margin-left: 0; }
            .sidebar-overlay.active { display: block; }
            .main-content { padding: 15px; }
            .charts-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; } 
            .resource-grid { grid-template-columns: 1fr; }
        }

        .sidebar-header { text-align: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; }
        .school-name { font-size: 0.85rem; opacity: 0.8; letter-spacing: 0.5px; margin-bottom: 5px; line-height: 1.4; font-weight: 500;}
        .app-name { font-size: 1.4rem; margin: 0; font-weight: bold; background: -webkit-linear-gradient(#00d2ff, #3a7bd5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .version-tag { font-size: 0.7rem; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; margin-top: 5px; display: inline-block; color: #bdc3c7; }

        .menu-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; border: 1px solid transparent; }
        .menu-item:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
        .menu-item.active { background: rgba(255,255,255,0.15); border-left: 4px solid var(--accent); transform: translateX(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .menu-icon { margin-right: 10px; width: 20px; text-align: center; }
        .user-info { margin-top: auto; padding-top:20px; border-top:1px solid rgba(255,255,255,0.2); font-size: 0.9rem; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid var(--accent-dark); }
        .stat-number { font-size: 2.5rem; font-weight: 800; color: var(--primary); margin: 10px 0; }
        
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; }
        
        .resource-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .card { background: white; border-radius: 12px; padding: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; transition: transform 0.2s; overflow: hidden; display: flex; flex-direction: column;}
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .card-content { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        
        .type-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 5px;
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            pointer-events: none;
        }

        .app-preview { width: 100%; height: 180px; object-fit: contain; background-color: #e0e0e0; border-bottom: 1px solid #ddd; display: block; }
        .app-preview-placeholder { height: 180px; background: linear-gradient(135deg, #e0e0e0, #f5f5f5); display: flex; align-items: center; justify-content: center; color: #aaa; font-size: 2rem; flex-direction: column;}
        .preview-icon { font-size: 3.5rem; margin-bottom: 10px; }
        .preview-type { font-size: 0.9rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; }

        .card.teaching { border-top: 5px solid var(--accent-dark); }
        .card.admin { border-top: 5px solid var(--admin-color); }
        .card.value-edu { border-top: 5px solid var(--value-edu-color); }
        
        .remark-alert { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px; border-radius: 6px; font-size: 0.85rem; margin: 10px 0; display: flex; align-items: flex-start; }
        .remark-icon { margin-right: 6px; font-size: 1rem; }

        .prompt-content-display {
            background: #2c3e50;
            color: #2ecc71;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 15px 0;
            min-height: 250px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.95rem;
            line-height: 1.6;
            white-space: pre-wrap;
            border: 1px solid #1a252f;
        }

        .rating-badge-container { display: flex; gap: 10px; margin: 15px 0; }
        .badge-rate { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px 10px; border-radius: 8px; color: white; font-weight: bold; min-width: 60px; }
        .bg-ease { background: linear-gradient(135deg, #f1c40f, #f39c12); }
        .bg-effect { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .rate-label { font-size: 0.7rem; text-transform: uppercase; opacity: 0.9; }
        .rate-score { font-size: 1.2rem; }
        
        .rating-form { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; font-size: 0.9rem; background: #fafafa; padding: 10px; border-radius: 5px;}
        .rating-input-row { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; flex-wrap: wrap; }
        .rating-select { padding: 2px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.8rem; }
        
        .comments-section { margin-top: 15px; border-top: 2px dashed #f0f0f0; padding-top: 15px; }
        .comments-title { font-size: 0.85rem; font-weight: bold; color: #7f8c8d; margin-bottom: 8px; }
        .comment-list { max-height: 120px; overflow-y: auto; font-size: 0.85rem; margin-bottom: 10px; padding-right: 5px; }
        .comment-item { margin-bottom: 6px; border-bottom: 1px dotted #eee; padding-bottom: 4px; line-height: 1.4; }
        .comment-author { font-weight: bold; color: var(--primary); margin-right: 3px; }
        .comment-content { color: #555; }
        .comment-input-group { display: flex; gap: 5px; }
        .comment-input { flex: 1; padding: 6px; font-size: 0.85rem; border: 1px solid #ddd; border-radius: 4px; }

        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            border-top: 1px solid #f0f0f0;
            padding-top: 10px;
        }

        .like-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .like-btn {
            background: none;
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 1.2rem;
            color: #7f8c8d;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .like-btn:hover {
            background: #f4f4f4;
            transform: scale(1.1);
        }

        .like-btn.liked {
            color: var(--danger);
            border-color: #f5b7b1;
            background-color: #fdebd0;
        }

        .like-count {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary);
        }

        .tags-container { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 5px; }
        .tag { padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; display: inline-flex; align-items: center;}
        
        .smart-tag { background: #e8f6f3; color: var(--success); border: 1px solid #d4efdf; }
        .keyword-tag { background: #f4f6f7; color: #5d6d7e; border: 1px solid #d5dbdb; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; font-weight: 600; }
        .btn-primary { background: linear-gradient(135deg, #3a7bd5, #00d2ff); color: white; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-success { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
        .btn-admin { background-color: var(--admin-color); color: white; }
        .btn-value { background-color: var(--value-edu-color); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-all { background-color: var(--all-btn-color); color: white; }
        .btn-outline { border: 1px solid #ccc; background: white; color: #555; }
        .btn-xs { padding: 4px 8px; font-size: 0.8rem; }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        .prompt-box { background: #f8f9fa; border-left: 3px solid #f39c12; padding: 10px; font-size: 0.85rem; color: #555; margin-bottom: 10px; white-space: pre-wrap; font-family: monospace; max-height: 80px; overflow-y: auto;}
        
        .cross-subject-grid, .tags-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; margin-top: 5px; transition: all 0.3s; }
        .checkbox-label { display: flex; align-items: center; font-size: 0.9rem; cursor: pointer; color: #555; }
        .checkbox-label input { margin-right: 8px; transform: scale(1.1); }
        .tag-category-title { font-size: 0.85rem; color: var(--accent-dark); font-weight: bold; margin-top: 10px; margin-bottom: 5px; width: 100%; grid-column: 1 / -1; border-bottom: 1px solid #e0e0e0; padding-bottom: 5px;}

        #loginModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(20, 30, 48, 0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        .lb-container { margin-top: 10px; }
        .lb-card { display: flex; align-items: center; background: #fcfcfc; border: 1px solid #eee; margin-bottom: 10px; padding: 12px; border-radius: 8px; transition: transform 0.2s; }
        .lb-card:hover { transform: translateX(5px); border-color: var(--accent-dark); }
        .lb-rank { width: 40px; font-size: 1.2rem; font-weight: 800; text-align: center; margin-right: 15px; }
        .lb-info { flex: 1; }
        .lb-name { font-weight: bold; font-size: 1rem; color: var(--primary); margin-bottom: 4px; }
        .lb-metrics { font-size: 0.8rem; color: #7f8c8d; display: flex; gap: 10px; }
        .lb-score-box { text-align: right; min-width: 70px; }
        .lb-score-val { font-size: 1.4rem; font-weight: 800; color: var(--accent-dark); line-height: 1; }
        .lb-score-label { font-size: 0.7rem; color: #95a5a6; }
        
        .rank-1 { color: var(--gold); }
        .rank-2 { color: var(--silver); }
        .rank-3 { color: var(--bronze); }
        .rank-rest { color: #bdc3c7; }
        .lb-card.top-3 { background: linear-gradient(to right, #fff, #fafafa); border-left: 4px solid; }
        .lb-card.top-3.r1 { border-left-color: var(--gold); }
        .lb-card.top-3.r2 { border-left-color: var(--silver); }
        .lb-card.top-3.r3 { border-left-color: var(--bronze); }
    </style>
</head>
<body>

    <div id="loginModal">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-top:0;">BCK-AI Hub V3.7</h2>
            <p style="color:#7f8c8d; margin-bottom:20px;">è«‹ä½¿ç”¨æ ¡æ–¹æ´¾ç™¼çš„å¸³è™Ÿç™»å…¥</p>
            <input type="email" id="loginEmail" class="form-control" placeholder="Email" style="margin-bottom:10px;">
            <input type="password" id="loginPass" class="form-control" placeholder="Password" style="margin-bottom:20px;">
            <button id="loginBtn" class="btn btn-primary" style="width:100%" onclick="handleLogin()">ç™»å…¥ç³»çµ±</button>
            <p style="margin-top:15px; font-size:0.8rem; color:#e74c3c;" id="loginMsg"></p>
        </div>
    </div>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar">
        <div class="sidebar-header">
            <div class="school-name">é¦™æµ·æ­£è¦ºè“®ç¤¾<br>ä½›æ•™æ­£è¦ºè“®ç¤¾å­¸æ ¡</div>
            <h2 class="app-name">BCK-AI Hub</h2>
            <div class="version-tag">V3.7 Mobile Dashboard Fix</div>
        </div>

        <div id="menu-dashboard" class="menu-item active" onclick="showPage('dashboard')"><span class="menu-icon">ğŸ“Š</span> æ•¸æ“šç¸½è¦½</div>
        <div id="menu-apps" class="menu-item" onclick="showPage('apps')"><span class="menu-icon">ğŸ“±</span> è³‡æºå±•ç¤ºåº«</div>
        <div id="menu-prompts" class="menu-item" onclick="showPage('prompts')"><span class="menu-icon">ğŸ’¡</span> å¥½Prompt åˆ†äº«</div>
        <div id="menu-upload" class="menu-item" onclick="showPage('upload')"><span class="menu-icon">ğŸ“¤</span> ä¸Šè¼‰åˆ†äº«</div>
        <div class="user-info">
            <p>ğŸ‘‹ <span id="currentUserDisplay">...</span> è€å¸«</p>
            <button class="btn btn-outline" style="width:100%; font-size:0.8rem; background:transparent; color:white; border:1px solid rgba(255,255,255,0.3);" onclick="logout()">ç™»å‡º</button>
        </div>
    </div>

    <div class="main-content">
        <div class="header-bar">
            <button class="menu-toggle-btn" onclick="toggleSidebar()">â˜°</button>
            <h2 style="margin:0; color:var(--primary); font-size:1.4rem;">BCK-AI Hub</h2>
        </div>

        <div id="dashboard" class="page active">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1>å¹³å°æ•¸æ“šå„€è¡¨æ¿</h1>
                <button class="btn btn-success" onclick="exportDataReport()">ğŸ“¥ åŒ¯å‡ºå ±å‘Š</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card" style="border-bottom-color: var(--accent-dark);">
                    <div class="stat-number" id="totalApps">0</div>
                    <div>å­¸æ•™è©•è³‡æº</div>
                </div>
                <div class="stat-card" style="border-bottom-color: var(--admin-color);">
                    <div class="stat-number" id="totalAdmin">0</div>
                    <div>è¡Œæ”¿æ•ˆèƒ½å·¥å…·</div>
                </div>
                <div class="stat-card" style="border-bottom-color: var(--warning);">
                    <div class="stat-number" id="totalPrompts">0</div>
                    <div>Prompt æŒ‡ä»¤</div>
                </div>
                <div class="stat-card" style="border-bottom-color: var(--success);">
                    <div class="stat-number" id="activeTeachers">0</div>
                    <div>åƒèˆ‡è€å¸«</div>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-box">
                    <h3 style="color:var(--accent-dark)">ğŸ“ å­¸æ•™è©•ï¼š5C+ ç´ é¤Šåˆ†ä½ˆ</h3>
                    <div style="height: 320px; position: relative;">
                        <canvas id="teachingChart"></canvas>
                    </div>
                </div>
                <div class="chart-box">
                    <h3 style="color:var(--accent-dark)">ğŸ“ å­¸æ•™è©•ï¼šå­¸ç§‘è³‡æºåˆ†ä½ˆ</h3>
                    <div style="height: 320px; position: relative;">
                        <canvas id="subjectChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-box" style="margin-bottom: 20px;">
                <h3 style="color:var(--admin-color)">ğŸ“‚ è¡Œæ”¿ï¼šæ•ˆèƒ½é¡åˆ¥åˆ†æ (å…¨è¦½)</h3>
                <div style="height: 350px; position: relative;">
                    <canvas id="adminChart"></canvas>
                </div>
            </div>
            
            <div class="chart-box">
                <h3 style="display:flex; align-items:center; justify-content:space-between;">
                    <span>ğŸ† æ´»èºè²¢ç»èˆ‡å„ªè³ªä½œå“æ’è¡Œæ¦œ</span>
                </h3>
                <div id="leaderboardList" class="lb-container"></div>
            </div>
        </div>

        <div id="apps" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h1>è³‡æºå±•ç¤ºåº«</h1>
                <div>
                    <button class="btn btn-all" onclick="filterApps('all')">å…¨éƒ¨</button>
                    <button class="btn btn-primary" onclick="filterApps('teaching')">å­¸æ•™è©•</button>
                    <button class="btn btn-value" onclick="filterApps('value')">ğŸ’— åƒ¹å€¼è§€æ•™è‚²</button>
                    <button class="btn btn-admin" onclick="filterApps('admin')">è¡Œæ”¿</button>
                </div>
            </div>
            <div id="appsContainer" class="resource-grid"></div>
        </div>

        <div id="prompts" class="page">
            <h1>å¥½ Prompt åˆ†äº«å€</h1>
            <div id="promptsContainer" class="resource-grid"></div>
        </div>

        <div id="upload" class="page">
            <h1>ä¸Šè¼‰ / ç·¨è¼¯è³‡æº</h1>
            <div style="background:white; padding:30px; border-radius:12px; max-width: 800px; margin:0 auto;">
                <input type="hidden" id="editModeId" value="">

                <div class="form-group">
                    <label>è³‡æºé¡å‹</label>
                    <select id="uploadType" class="form-control" onchange="toggleUploadForm()">
                        <option value="app">ä¸Šè¼‰ä½œå“ (App/æª”æ¡ˆ/æ•™æ¡ˆ)</option>
                        <option value="prompt">ç´”åˆ†äº« AI Prompt (æŒ‡ä»¤)</option>
                    </select>
                </div>

                <div id="appForm">
                    <div class="form-group">
                        <label>ä½œå“åç¨±</label>
                        <input type="text" id="appTitle" class="form-control" placeholder="ä¾‹å¦‚ï¼šè‡ªå‹•å‡ºå·ç¥å™¨">
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div class="form-group">
                            <label>ä¸»åˆ†é¡</label>
                            <select id="appCategory" class="form-control" onchange="handleCategoryChange()">
                                <option value="teaching">å­¸æ•™è©• (Teaching)</option>
                                <option value="admin">è¡Œæ”¿ (Admin)</option>
                            </select>
                        </div>
                        <div class="form-group" id="subjectGroup">
                            <label>é©ç”¨ç§‘ç›®</label>
                            <select id="appSubject" class="form-control" onchange="handleSubjectChange()">
                                <option value="ä¸­æ–‡">ä¸­æ–‡</option>
                                <option value="è‹±æ–‡">è‹±æ–‡</option>
                                <option value="æ•¸å­¸">æ•¸å­¸</option>
                                <option value="å¸¸è­˜/ç§‘å­¸">å¸¸è­˜/ç§‘å­¸</option>
                                <option value="äººæ–‡">äººæ–‡</option>
                                <option value="è¦–è—">è¦–è—</option>
                                <option value="éŸ³æ¨‚">éŸ³æ¨‚</option>
                                <option value="é«”è‚²">é«”è‚²</option>
                                <option value="åœ–æ›¸">åœ–æ›¸</option>
                                <option value="æ™®é€šè©±">æ™®é€šè©±</option>
                                <option value="ä½›å­¸">ä½›å­¸</option>
                                <option value="ç§‘æŠ€">ç§‘æŠ€</option>
                                <option value="åƒ¹å€¼è§€æ•™è‚²">åƒ¹å€¼è§€æ•™è‚²</option>
                                <option value="è·¨èª²ç¨‹">è·¨èª²ç¨‹ (è«‹é¸æ­¤é …ä»¥é€²è¡Œè¤‡é¸)</option>
                            </select>
                            <div id="crossSubjectSection" style="display:none; margin-top:10px;">
                                <label style="font-size:0.9rem; color:#e67e22;">è«‹å‹¾é¸æ¶‰åŠçš„ç§‘ç›®ï¼š</label>
                                <div class="cross-subject-grid" id="crossSubjectCheckboxes"></div>
                            </div>
                        </div>
                        <div class="form-group" id="adminTypeGroup" style="display:none;">
                            <label>è¡Œæ”¿é¡åˆ¥</label>
                            <select id="appAdminType" class="form-control">
                                <option value="æ ¡å‹™é‹ä½œ">æ ¡å‹™é‹ä½œ (æ—¥å¸¸æµç¨‹ã€æ”¾å­¸ã€é»å)</option>
                                <option value="æ–‡æ›¸è™•ç†">æ–‡æ›¸è™•ç† (å ±å‘Šã€æœƒè­°è¨˜éŒ„)</option>
                                <option value="æ•¸æ“šåˆ†æ">æ•¸æ“šåˆ†æ (æˆç¸¾ã€å•å·çµ±è¨ˆ)</option>
                                <option value="è³‡è¨Šé€šè¨Š">è³‡è¨Šé€šè¨Š (é€šå‘Šã€å®£å‚³ã€è¯çµ¡)</option>
                                <option value="æ´»å‹•ç­–åŠƒ">æ´»å‹•ç­–åŠƒ (æ—…è¡Œã€æ¯”è³½ç±Œå‚™)</option>
                                <option value="è³‡æºç®¡ç†">è³‡æºç®¡ç† (ç‰©è³‡ã€å ´åœ°)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æª”æ¡ˆé¡å‹</label>
                        <select id="resourceType" class="form-control" onchange="handleResourceTypeChange()">
                            <option value="url">ğŸŒ ç¶²é é€£çµ (URL)</option>
                            <option value="image">ğŸ–¼ï¸ åœ–ç‰‡ (Image)</option>
                            <option value="video">ğŸ¬ å½±ç‰‡ (Video)</option>
                            <option value="audio">ğŸ”Š è²éŸ³ (Audio)</option>
                            <option value="presentation">ğŸ“Š ç°¡å ± (PPT/Canva)</option>
                            <option value="worksheet">ğŸ“„ å·¥ä½œç´™ (PDF/Word)</option>
                            <option value="lessonplan">ğŸ“ æ•™æ¡ˆ (Lesson Plan)</option>
                        </select>
                    </div>

                    <div class="form-group" id="linkInputGroup">
                        <label id="linkLabel">é€£çµ (URL)</label>
                        <input type="text" id="appLink" class="form-control" placeholder="https://...">
                    </div>

                    <div class="form-group" id="fileInputGroup" style="display:none;">
                        <label>ä¸Šå‚³åœ–ç‰‡ (æ”¯æ´ JPG/PNG)</label>
                        <input type="file" id="appFile" class="form-control" accept="image/*">
                        <input type="hidden" id="appFileBase64">
                        <div id="imagePreviewBox" style="margin-top:10px; max-width:200px; display:none;">
                            <img id="imagePreview" src="" style="width:100%; border-radius:8px; border:1px solid #ddd;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>è§£æ±ºäº†ä»€éº¼é›£é»ï¼Ÿ</label>
                        <input type="text" id="appPainPoint" class="form-control" placeholder="ä¾‹å¦‚ï¼šç¯€çœäº†æ¯é€± 2 å°æ™‚çš„æ’ç‰ˆæ™‚é–“">
                    </div>

                    <div class="form-group">
                        <label style="color:var(--danger)">âš ï¸ ç‰¹åˆ¥å‚™è¨» (Optional)</label>
                        <input type="text" id="appRemarks" class="form-control" placeholder="ä¾‹å¦‚ï¼šè«‹å‹¿éš¨æ„æ›´æ”¹ç³»çµ±è¨­å®šå¯†ç¢¼ / ä½¿ç”¨å‰è«‹å…ˆå‚™ä»½..." style="border-color:#f5b7b1;">
                    </div>
                    
                    <div class="form-group">
                        <label>Prompt: (åƒè€ƒæŒ‡ä»¤)</label>
                        <textarea id="appPrompt" class="form-control" rows="4" style="font-family:monospace; background:#fafafa;" placeholder="è«‹è²¼ä¸Šç”Ÿæˆæ­¤è³‡æºçš„ AI æŒ‡ä»¤..." onblur="triggerAutoTag()"></textarea>
                    </div>

                    <div class="form-group">
                        <label>5C+ / é—œéµå­—æ¨™ç±¤ (åªé©ç”¨æ–¼å­¸æ•™è©•)</label>
                        <div id="tagsCheckboxContainer" class="tags-grid">
                        </div>
                    </div>
                </div>

                <div id="promptForm" style="display:none;">
                    <div class="form-group">
                        <label>Prompt ä¸»é¡Œ</label>
                        <input type="text" id="promptTitle" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>æŒ‡ä»¤å…§å®¹</label>
                        <textarea id="promptContent" class="form-control" rows="6" style="font-family:monospace"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ç”¨é€”/ç›®æ¨™</label>
                        <input type="text" id="promptPurpose" class="form-control">
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button id="submitBtn" class="btn btn-primary" style="flex:2" onclick="submitUpload()">ç¢ºèªç™¼å¸ƒ</button>
                    <button id="cancelBtn" class="btn btn-outline" style="flex:1; display:none" onclick="resetForm(true)">å–æ¶ˆç·¨è¼¯</button>
                    <button id="deleteBtn" class="btn btn-danger" style="flex:1; display:none" onclick="deleteResource()">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBPRN5_vnvMOPAR0fTVaZoqM57ffIGZOQU",
          authDomain: "bck-ai-hub.firebaseapp.com",
          projectId: "bck-ai-hub",
          storageBucket: "bck-ai-hub.firebasestorage.app",
          messagingSenderId: "1010987556331",
          appId: "1:1010987556331:web:07dac81847056ae7520dae"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentUser = null;
        let teachingChartRef = null;
        let subjectChartRef = null;
        let adminChartRef = null;

        const teacherDirectory = {
            "lwysams@bcklas.edu.hk": "ç©", "slssams@bcklas.edu.hk": "çŠ", "ckysams@bcklas.edu.hk": "å¾",
            "cymsams@bcklas.edu.hk": "æ–‡", "lysams@bcklas.edu.hk": "ç‡•", "hhysams@bcklas.edu.hk": "ä¾¯",
            "scysams@bcklas.edu.hk": "è˜‡", "ccwsams@bcklas.edu.hk": "ç‘‹", "ynysams@bcklas.edu.hk": "æ¥Š",
            "csysams@bcklas.edu.hk": "æ·‘", "dspsams@bcklas.edu.hk": "ä¸", "cherry@bcklas.edu.hk": "Cherry",
            "lslsams@bcklas.edu.hk": "éˆ´", "cpy2sams@bcklas.edu.hk": "å®¹", "lsysams@bcklas.edu.hk": "å‘‚",
            "twksams@bcklas.edu.hk": "æ…§", "wpwsams@bcklas.edu.hk": "æ¦®", "skysams@bcklas.edu.hk": "å…’",
            "cym2sams@bcklas.edu.hk": "ç¶º", "swysams@bcklas.edu.hk": "æ²ˆ", "whwsams@bcklas.edu.hk": "é¦¨",
            "ywysams@bcklas.edu.hk": "ä¿"
        };

        const subjectList = ["ä¸­æ–‡", "è‹±æ–‡", "æ•¸å­¸", "å¸¸è­˜/ç§‘å­¸", "äººæ–‡", "è¦–è—", "éŸ³æ¨‚", "é«”è‚²", "åœ–æ›¸", "æ™®é€šè©±", "ä½›å­¸", "ç§‘æŠ€", "åƒ¹å€¼è§€æ•™è‚²"];
        const adminColors = { "æ ¡å‹™é‹ä½œ": "#3498db", "æ–‡æ›¸è™•ç†": "#9b59b6", "æ•¸æ“šåˆ†æ": "#2ecc71", "è³‡è¨Šé€šè¨Š": "#e67e22", "æ´»å‹•ç­–åŠƒ": "#e74c3c", "è³‡æºç®¡ç†": "#f1c40f", "æœªåˆ†é¡": "#95a5a6" };
        const subjectColors = { "ä¸­æ–‡": "#e74c3c", "è‹±æ–‡": "#3498db", "æ•¸å­¸": "#f39c12", "å¸¸è­˜/ç§‘å­¸": "#27ae60", "äººæ–‡": "#8e44ad", "è¦–è—": "#e91e63", "éŸ³æ¨‚": "#1abc9c", "é«”è‚²": "#34495e", "åœ–æ›¸": "#d35400", "æ™®é€šè©±": "#c0392b", "ä½›å­¸": "#f1c40f", "ç§‘æŠ€": "#16a085", "åƒ¹å€¼è§€æ•™è‚²": "#e91e63", "è·¨èª²ç¨‹": "#7f8c8d" };

        const tag5C = [
            {val: "Creativity", label: "å‰µæ„ (Creativity)"},
            {val: "Critical Thinking", label: "æ˜è¾¨ (Critical Thinking)"},
            {val: "Communication", label: "æºé€š (Communication)"},
            {val: "Collaboration", label: "å”ä½œ (Collaboration)"},
            {val: "Contribution", label: "è²¢ç» (Contribution)"}
        ];
        
        const tagMap = {};
        const tag5CValues = []; 
        tag5C.forEach(t => { 
            tagMap[t.val] = t.label;
            tag5CValues.push(t.val);
        });

        const tagKeywords = ["AI ç”Ÿæˆ", "è©•ä¼°å·¥å…·", "èª²å ‚ç®¡ç†", "å‚™èª²è¼”åŠ©", "å·®ç•°åŒ–æ•™å­¸", "å­¸ç”Ÿè‡ªå­¸", "å°ˆé¡Œç ”ç¿’", "éŠæˆ²åŒ–å­¸ç¿’", "è¡Œæ”¿æ•ˆç‡", "å…¶ä»–"];

        // Resource Type Config
        const resourceTypeConfig = {
            'url': { icon: 'ğŸŒ', label: 'ç¶²é ', color: '#3498db' },
            'image': { icon: 'ğŸ–¼ï¸', label: 'åœ–ç‰‡', color: '#9b59b6' },
            'video': { icon: 'ğŸ¬', label: 'å½±ç‰‡', color: '#e74c3c' },
            'audio': { icon: 'ğŸ”Š', label: 'è²éŸ³', color: '#f1c40f' },
            'presentation': { icon: 'ğŸ“Š', label: 'ç°¡å ±', color: '#e67e22' },
            'worksheet': { icon: 'ğŸ“„', label: 'æ–‡ä»¶', color: '#2ecc71' },
            'lessonplan': { icon: 'ğŸ“', label: 'æ•™æ¡ˆ', color: '#1abc9c' }
        };

        function initSubjectCheckboxes() {
            const container = document.getElementById('crossSubjectCheckboxes');
            container.innerHTML = '';
            subjectList.forEach(sub => { container.innerHTML += `<label class="checkbox-label"><input type="checkbox" name="crossSub" value="${sub}"> ${sub}</label>`; });
        }
        initSubjectCheckboxes();

        function initTagCheckboxes() {
            const container = document.getElementById('tagsCheckboxContainer');
            container.innerHTML = `<div class="tag-category-title">ğŸŒŸ 5C+ æ ¸å¿ƒç´ é¤Š</div>`;
            tag5C.forEach(t => {
                container.innerHTML += `<label class="checkbox-label"><input type="checkbox" name="appTag" value="${t.val}"> ${t.label}</label>`;
            });
            container.innerHTML += `<div class="tag-category-title">ğŸ”‘ åŠŸèƒ½é—œéµå­—</div>`;
            tagKeywords.forEach(k => {
                container.innerHTML += `<label class="checkbox-label"><input type="checkbox" name="appTag" value="${k}"> ${k}</label>`;
            });
        }
        initTagCheckboxes();

        auth.onAuthStateChanged((user) => {
            if (user) {
                let finalName = teacherDirectory[user.email];
                if (!finalName) finalName = user.email.split('@')[0];
                currentUser = { name: finalName, email: user.email, uid: user.uid };
                document.getElementById('loginModal').style.display = 'none';
                updateUserDisplay();
                loadData();
            } else {
                currentUser = null;
                document.getElementById('loginModal').style.display = 'flex';
            }
        });

        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            const msg = document.getElementById('loginMsg');
            msg.innerText = "ç™»å…¥ä¸­...";
            auth.signInWithEmailAndPassword(email, pass).catch(error => msg.innerText = "ç™»å…¥å¤±æ•—: " + error.message);
        }

        function logout() { auth.signOut().then(() => location.reload()); }
        function updateUserDisplay() { document.getElementById('currentUserDisplay').innerText = currentUser.name; }
        
        function toggleSidebar() { 
            if(window.innerWidth > 768) {
                document.body.classList.toggle('desktop-collapsed');
            } else {
                document.querySelector('.sidebar').classList.toggle('active'); 
                document.querySelector('.sidebar-overlay').classList.toggle('active'); 
            }
        }

        async function loadData() {
            try {
                const appsSnap = await db.collection('apps').orderBy('timestamp', 'desc').get();
                const apps = appsSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                const promptsSnap = await db.collection('prompts').orderBy('timestamp', 'desc').get();
                const prompts = promptsSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderDashboard(apps, prompts);
                renderApps(apps);
                renderPrompts(prompts);
            } catch (e) { console.error("Error loading data:", e); }
        }

        function handleResourceTypeChange() {
            const type = document.getElementById('resourceType').value;
            const linkGroup = document.getElementById('linkInputGroup');
            const fileGroup = document.getElementById('fileInputGroup');
            const linkLabel = document.getElementById('linkLabel');
            if (type === 'image') { linkGroup.style.display = 'none'; fileGroup.style.display = 'block'; } else { linkGroup.style.display = 'block'; fileGroup.style.display = 'none'; if (type === 'video') linkLabel.innerText = "å½±ç‰‡é€£çµ (YouTube/Google Drive)"; else if (type === 'presentation' || type === 'worksheet' || type === 'lessonplan') linkLabel.innerText = "é›²ç«¯ç¡¬ç¢Ÿé€£çµ (Google Drive/OneDrive)"; else linkLabel.innerText = "ç¶²é é€£çµ (URL)"; }
        }

        document.getElementById('appFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    document.getElementById('appFileBase64').value = evt.target.result;
                    document.getElementById('imagePreview').src = evt.target.result;
                    document.getElementById('imagePreviewBox').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        function renderApps(apps) {
            const container = document.getElementById('appsContainer');
            container.innerHTML = '';
            apps.forEach(app => {
                try {
                    let tagsHtml = '';
                    if (app.tags && Array.isArray(app.tags) && app.tags.length > 0) {
                        const fiveCTags = [];
                        const kwTags = [];
                        
                        app.tags.forEach(t => {
                            if (!t) return;
                            if (tag5CValues.includes(t)) {
                                fiveCTags.push(tagMap[t]);
                            } else {
                                kwTags.push(t);
                            }
                        });

                        let innerHtml = '';
                        fiveCTags.forEach(label => { innerHtml += `<span class="tag smart-tag">ğŸŒŸ ${label}</span>`; });
                        kwTags.forEach(label => { innerHtml += `<span class="tag keyword-tag">ğŸ·ï¸ ${label}</span>`; });
                        
                        tagsHtml = `<div class="tags-container">${innerHtml}</div>`;
                    }
                    
                    let catBadge = '';
                    let cardClass = app.category;
                    
                    if (app.category === 'teaching') {
                        if (app.subject === 'è·¨èª²ç¨‹') {
                            const validCrossSubs = (app.crossSubjects || []).filter(s => s && s.trim() !== "");
                            const crossText = validCrossSubs.length > 0 ? validCrossSubs.join(' + ') : 'ç¶œåˆ';
                            catBadge = `<span class="tag" style="background:#7f8c8d; color:white">è·¨èª²ç¨‹: ${crossText}</span>`;
                        } else if (app.subject === 'åƒ¹å€¼è§€æ•™è‚²') {
                            catBadge = `<span class="tag" style="background:var(--value-edu-color); color:white">ğŸ’— ${app.subject}</span>`;
                            cardClass = 'value-edu';
                        } else {
                            const color = subjectColors[app.subject] || 'var(--accent-dark)';
                            catBadge = `<span class="tag" style="background:${color}; color:white">å­¸æ•™è©•: ${app.subject}</span>`;
                        }
                    } else {
                        const color = adminColors[app.adminType] || 'var(--admin-color)';
                        catBadge = `<span class="tag" style="background:${color}; color:white">è¡Œæ”¿: ${app.adminType}</span>`;
                    }
                    
                    const isAuthor = (app.author === currentUser.name) || (app.authorEmail && app.authorEmail === currentUser.email);
                    const editBtn = isAuthor ? `<button class="btn btn-outline" style="font-size:0.7rem; float:right" onclick='editApp(${JSON.stringify(app)})'>âœï¸ ç·¨è¼¯</button>` : '';
                    
                    let previewHtml = '';
                    const type = app.resourceType || 'url';
                    
                    const typeInfo = resourceTypeConfig[type] || resourceTypeConfig['url'];
                    const typeBadgeHtml = `<div class="type-badge">${typeInfo.icon} ${typeInfo.label}</div>`;

                    if (type === 'image' && app.link && app.link.startsWith('data:image')) {
                        previewHtml = `<img src="${app.link}" class="app-preview" style="object-fit:contain;">`;
                    } else if (type === 'video') {
                        previewHtml = `<div class="app-preview-placeholder"><div class="preview-icon">ğŸ¬</div><div class="preview-type">Video Resource</div></div>`;
                    } else if (type === 'audio') {
                        previewHtml = `<div class="app-preview-placeholder"><div class="preview-icon">ğŸ”Š</div><div class="preview-type">Audio Clip</div></div>`;
                    } else if (type === 'presentation') {
                        previewHtml = `<div class="app-preview-placeholder"><div class="preview-icon">ğŸ“Š</div><div class="preview-type">Presentation</div></div>`;
                    } else if (type === 'worksheet') {
                        previewHtml = `<div class="app-preview-placeholder"><div class="preview-icon">ğŸ“„</div><div class="preview-type">Worksheet</div></div>`;
                    } else if (type === 'lessonplan') {
                        previewHtml = `<div class="app-preview-placeholder"><div class="preview-icon">ğŸ“</div><div class="preview-type">Lesson Plan</div></div>`;
                    } else {
                        if(app.link && app.link.startsWith('http')) {
                            previewHtml = `<img src="https://image.thum.io/get/width/600/allowJPG/${app.link}" class="app-preview" onerror="this.style.display='none'">`;
                        } else {
                            previewHtml = `<div class="app-preview-placeholder"><div class="preview-icon">ğŸŒ</div></div>`;
                        }
                    }

                    const ratings = app.ratings || {};
                    const ratingValues = Object.values(ratings);
                    let avgEase = "-", avgEffect = "-";
                    if (ratingValues.length > 0) {
                        const totalEase = ratingValues.reduce((sum, r) => sum + (r.ease||0), 0);
                        const totalEffect = ratingValues.reduce((sum, r) => sum + (r.effect||0), 0);
                        avgEase = (totalEase / ratingValues.length).toFixed(1);
                        avgEffect = (totalEffect / ratingValues.length).toFixed(1);
                    }

                    const hasRated = ratings[currentUser.uid];
                    let ratingHtml = hasRated 
                        ? `<div style="margin-top:5px; color:var(--success); font-size:0.85rem;">âœ… ä½ å·²è©•åƒ¹ (æ˜“: ${hasRated.ease}, æ•ˆ: ${hasRated.effect})</div>`
                        : `<div class="rating-form"><div class="rating-input-row"><label>æ˜“ç”¨:</label><select id="ease_${app.id}" class="rating-select"><option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select><label>æˆæ•ˆ:</label><select id="effect_${app.id}" class="rating-select"><option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select><button class="btn btn-primary btn-xs" onclick="submitRating('${app.id}')">è©•åˆ†</button></div></div>`;

                    let commentsHtml = '';
                    if(app.comments && app.comments.length > 0) {
                        app.comments.forEach(c => { commentsHtml += `<div class="comment-item"><span class="comment-author">${c.author}ï¼š</span><span class="comment-content">${c.content}</span></div>`; });
                    } else { commentsHtml = `<div style="color:#ccc; font-style:italic; font-size:0.8rem; padding:5px 0;">æš«ç„¡ç•™è¨€</div>`; }

                    let dateStr = "(èˆŠè³‡æ–™)";
                    if(app.timestamp) {
                        try {
                            const dateObj = new Date(app.timestamp);
                            dateStr = dateObj.toLocaleString('zh-HK', { timeZone: 'Asia/Hong_Kong', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
                        } catch(e) {}
                    }

                    const promptHtml = app.promptText ? `<div class="prompt-box" title="Prompt æŒ‡ä»¤">${app.promptText}</div>` : '';
                    const remarksHtml = app.remarks ? `<div class="remark-alert"><span class="remark-icon">âš ï¸</span><span><strong>å‚™è¨»ï¼š</strong>${app.remarks}</span></div>` : '';

                    let html = `
                        <div class="card ${cardClass}" data-cat="${app.category}" data-sub="${app.subject}">
                            ${typeBadgeHtml} 
                            ${previewHtml}
                            <div class="card-content">
                                <h3 style="margin-top:0">${app.title} ${editBtn}</h3>
                                <div style="font-size:0.85rem; color:#7f8c8d; margin-bottom:10px;">
                                    ç”± ${app.author} æä¾› â€¢ <span style="font-size:0.75rem">${dateStr}</span>
                                </div>
                                <div>${catBadge}</div>
                                <p style="font-size:0.9rem; color:#444"><strong>ğŸ’¡ è§£æ±ºé›£é»ï¼š</strong> ${app.painPoint}</p>
                                ${remarksHtml}
                                ${promptHtml}
                                ${tagsHtml}
                                <div class="rating-badge-container">
                                    <div class="badge-rate bg-ease"><span class="rate-label">æ˜“ç”¨åº¦</span><span class="rate-score">${avgEase}</span></div>
                                    <div class="badge-rate bg-effect"><span class="rate-label">æˆæ•ˆ</span><span class="rate-score">${avgEffect}</span></div>
                                </div>
                                ${ratingHtml}
                                <div class="comments-section">
                                    <div class="comments-title">ğŸ’¬ åŒäº‹ç•™è¨€</div>
                                    <div class="comment-list">${commentsHtml}</div>
                                    <div class="comment-input-group">
                                        <input type="text" id="comment_input_${app.id}" class="comment-input" placeholder="æ’°å¯«ç•™è¨€...">
                                        <button class="btn btn-primary btn-xs" onclick="submitComment('${app.id}')">é€å‡º</button>
                                    </div>
                                </div>
                                <a href="${app.link}" target="_blank" class="btn btn-primary" style="display:block; text-align:center; margin-top:10px;">å‰å¾€è³‡æº</a>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                } catch(err) {
                    console.error("Skipping bad app entry:", app, err);
                }
            });
        }

        function renderDashboard(apps, prompts) {
            const teachingApps = apps.filter(a => a.category === 'teaching');
            const adminApps = apps.filter(a => a.category === 'admin');
            
            document.getElementById('totalApps').innerText = teachingApps.length;
            document.getElementById('totalAdmin').innerText = adminApps.length;
            document.getElementById('totalPrompts').innerText = prompts.length;
            
            const authors = new Set([...apps.map(a=>a.author), ...prompts.map(p=>p.author)]);
            document.getElementById('activeTeachers').innerText = authors.size;

            const skillCounts = { "Communication":0, "Contribution":0, "Creativity":0, "Critical Thinking":0, "Collaboration":0 };
            
            teachingApps.forEach(a => {
                let tagsList = [];
                if (a.tags) {
                    if (Array.isArray(a.tags)) { tagsList = a.tags; } 
                    else if (typeof a.tags === 'string') { tagsList = a.tags.split(',').map(t => t.trim()); }
                }
                
                tagsList.forEach(t => {
                    if(!t) return;
                    const tagLower = t.toLowerCase();
                    if(tagLower.includes("creativity")) skillCounts["Creativity"]++;
                    else if(tagLower.includes("critical")) skillCounts["Critical Thinking"]++;
                    else if(tagLower.includes("communication")) skillCounts["Communication"]++;
                    else if(tagLower.includes("collaboration")) skillCounts["Collaboration"]++;
                    else if(tagLower.includes("contribution")) skillCounts["Contribution"]++;
                });
            });

            if(teachingChartRef) teachingChartRef.destroy();
            teachingChartRef = new Chart(document.getElementById('teachingChart').getContext('2d'), { 
                type: 'radar', 
                data: { 
                    labels: ["å‰µæ„ Creativity", "æ˜è¾¨ Critical Thinking", "æºé€š Communication", "å”ä½œ Collaboration", "è²¢ç» Contribution"], 
                    datasets: [{ 
                        label: '5C+ ç´ é¤Šåˆ†ä½ˆ', 
                        data: [skillCounts["Creativity"], skillCounts["Critical Thinking"], skillCounts["Communication"], skillCounts["Collaboration"], skillCounts["Contribution"]], 
                        backgroundColor: 'rgba(52, 152, 219, 0.2)', 
                        borderColor: '#3498db',
                        pointBackgroundColor: '#3498db'
                    }] 
                }, 
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { r: { beginAtZero: true, suggestedMax: Math.max(5, ...Object.values(skillCounts)), ticks: { stepSize: 1 } } } 
                } 
            });

            const subjectCounts = {};
            teachingApps.forEach(a => { const subj = a.subject || "æœªåˆ†é¡"; subjectCounts[subj] = (subjectCounts[subj] || 0) + 1; });
            if(subjectChartRef) subjectChartRef.destroy();
            subjectChartRef = new Chart(document.getElementById('subjectChart').getContext('2d'), { 
                type: 'pie', 
                data: { 
                    labels: Object.keys(subjectCounts), 
                    datasets: [{ data: Object.values(subjectCounts), backgroundColor: Object.keys(subjectCounts).map(l => subjectColors[l] || "#95a5a6") }] 
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            const adminCounts = {};
            adminApps.forEach(a => { const type = a.adminType || "æœªåˆ†é¡"; adminCounts[type] = (adminCounts[type] || 0) + 1; });
            if(adminChartRef) adminChartRef.destroy();
            adminChartRef = new Chart(document.getElementById('adminChart').getContext('2d'), { type: 'bar', data: { labels: Object.keys(adminCounts), datasets: [{ label: 'è¡Œæ”¿å·¥å…·åˆ†é¡', data: Object.values(adminCounts), backgroundColor: Object.keys(adminCounts).map(t => adminColors[t] || "#34495e"), borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } } });

            const authorStats = {};
            Object.values(teacherDirectory).forEach(name => { authorStats[name] = { count: 0, sumRating: 0, ratedItems: 0, avgRating: 0, bestItem: null, maxScore: 0 }; });
            [...apps, ...prompts].forEach(item => {
                const author = item.author;
                if(!author) return;
                if(!authorStats[author]) authorStats[author] = { count: 0, sumRating: 0, ratedItems: 0, avgRating: 0, bestItem: null, maxScore: 0 };
                const s = authorStats[author]; s.count++;
                let itemAvg = 0;
                if (item.ratings) { const rVals = Object.values(item.ratings); if (rVals.length > 0) { const sum = rVals.reduce((acc, r) => acc + (r.ease + r.effect)/2, 0); itemAvg = sum / rVals.length; } }
                if(itemAvg > 0) { s.sumRating += itemAvg; s.ratedItems++; }
                if(itemAvg > s.maxScore) { s.maxScore = itemAvg; s.bestItem = item; }
                if(!s.bestItem) s.bestItem = item;
            });
            
            let maxContributionCount = 0;
            Object.values(authorStats).forEach(s => { if(s.ratedItems > 0) s.avgRating = s.sumRating / s.ratedItems; if(s.count > maxContributionCount) maxContributionCount = s.count; });
            if(maxContributionCount === 0) maxContributionCount = 1;

            const leaderboardData = Object.keys(authorStats).map(name => {
                const s = authorStats[name];
                const scoreQty = (s.count / maxContributionCount) * 50;
                const scoreQuality = s.avgRating > 0 ? (s.avgRating / 5) * 50 : 0;
                return { name: name, count: s.count, avg: s.avgRating.toFixed(1), bestItem: s.bestItem, maxItemScore: s.maxScore, finalScore: (scoreQty + scoreQuality).toFixed(1) };
            }).filter(d => d.count > 0);
            leaderboardData.sort((a,b) => b.finalScore - a.finalScore);

            const lb = document.getElementById('leaderboardList'); lb.innerHTML = '';
            leaderboardData.slice(0, 10).forEach((data, index) => {
                const rank = index + 1;
                let rankClass = "rank-rest", rowClass = "", rankIcon = `#${rank}`;
                if(rank === 1) { rankClass = "rank-1"; rowClass = "top-3 r1"; rankIcon = "ğŸ¥‡"; }
                else if(rank === 2) { rankClass = "rank-2"; rowClass = "top-3 r2"; rankIcon = "ğŸ¥ˆ"; }
                else if(rank === 3) { rankClass = "rank-3"; rowClass = "top-3 r3"; rankIcon = "ğŸ¥‰"; }
                const bestTitle = (data.bestItem && data.bestItem.title) ? (data.bestItem.title.length > 8 ? data.bestItem.title.substring(0,8)+"..." : data.bestItem.title) : "å°šç„¡";
                const linkAction = (data.bestItem && data.bestItem.id) ? `onclick="focusOnItem('${data.bestItem.id}', '${data.bestItem.link ? 'app' : 'prompt'}')"` : `style="pointer-events:none; color:#ccc"`;
                lb.innerHTML += `<div class="lb-card ${rowClass}"><div class="lb-rank ${rankClass}">${rankIcon}</div><div class="lb-info"><div class="lb-name">${data.name}</div><div class="lb-metrics"><span>ğŸ“¦ è²¢ç»: ${data.count}</span><span>â­ å¹³å‡: ${data.avg}</span><span>ğŸ† ä»£è¡¨ä½œ: <a href="#" ${linkAction} style="text-decoration:none; color:inherit;">${bestTitle}</a></span></div></div><div class="lb-score-box"><div class="lb-score-val">${data.finalScore}</div><div class="lb-score-label">æˆ°åŠ›æŒ‡æ•¸</div></div></div>`;
            });
        }

        function renderPrompts(prompts) {
            const container = document.getElementById('promptsContainer'); container.innerHTML = '';
            prompts.forEach(p => {
                let dateStr = "(èˆŠè³‡æ–™)";
                try { if(p.timestamp) dateStr = new Date(p.timestamp).toLocaleString('zh-HK', { timeZone: 'Asia/Hong_Kong', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }); } catch(e){}
                
                const isAuthor = (p.author === currentUser.name) || (p.authorEmail && p.authorEmail === currentUser.email);
                const editBtn = isAuthor ? `<button class="btn btn-outline" style="font-size:0.7rem; float:right; margin-left:10px;" onclick='editPrompt(${JSON.stringify(p)})'>âœï¸ ç·¨è¼¯</button>` : '';

                const likes = p.likes || [];
                const userHasLiked = likes.includes(currentUser.uid);
                const likeBtnClass = userHasLiked ? 'liked' : '';

                let commentsHtml = '';
                if(p.comments && p.comments.length > 0) {
                    p.comments.forEach(c => { commentsHtml += `<div class="comment-item"><span class="comment-author">${c.author}ï¼š</span><span class="comment-content">${c.content}</span></div>`; });
                } else { 
                    commentsHtml = `<div style="color:#ccc; font-style:italic; font-size:0.8rem; padding:5px 0;">æš«ç„¡ç•™è¨€ï¼Œå¿«ä¾†ç¬¬ä¸€å€‹åˆ†äº«å§ï¼</div>`; 
                }

                container.innerHTML += `
                <div class="card" id="prompt-${p.id}">
                    <div class="card-content">
                        <h3>${p.title} ${editBtn} <br><small style="font-size:0.8rem; font-weight:normal; color:#7f8c8d">${p.author} â€¢ ${dateStr}</small></h3>
                        <p><strong>ğŸ¯ ç”¨é€”ï¼š</strong>${p.purpose}</p>
                        <div class="prompt-content-display">${p.content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>

                        <div class="actions-bar">
                             <div class="like-section">
                                <button class="like-btn ${likeBtnClass}" onclick="handlePromptLike('${p.id}', ${userHasLiked})">â¤ï¸</button>
                                <span class="like-count">${likes.length} äººè®šå¥½</span>
                            </div>
                            <button class="btn btn-outline" onclick="navigator.clipboard.writeText(\`${p.content.replace(/`/g, "\\`")}\`);alert('å·²è¤‡è£½ï¼')">è¤‡è£½æŒ‡ä»¤</button>
                        </div>
                        
                        <div class="comments-section">
                            <div class="comments-title">ğŸ’¬ äº¤æµèˆ‡å›æ‡‰</div>
                            <div class="comment-list">${commentsHtml}</div>
                            <div class="comment-input-group">
                                <input type="text" id="prompt_comment_input_${p.id}" class="comment-input" placeholder="å°æ­¤ Prompt æå‡ºå»ºè­°æˆ–åˆ†äº«ç”¨æ³•...">
                                <button class="btn btn-primary btn-xs" onclick="submitPromptComment('${p.id}')">é€å‡º</button>
                            </div>
                        </div>

                    </div>
                </div>`;
            });
        }

        function handlePromptLike(promptId, userHasLiked) {
            const docRef = db.collection('prompts').doc(promptId);
            const operation = userHasLiked 
                ? firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                : firebase.firestore.FieldValue.arrayUnion(currentUser.uid);

            docRef.update({ likes: operation }).then(() => {
                loadData();
            }).catch(e => {
                console.error("Like operation failed, trying to set.", e);
                if (!userHasLiked) {
                    docRef.set({ likes: [currentUser.uid] }, { merge: true }).then(() => loadData());
                }
            });
        }

        function submitPromptComment(promptId) {
            const input = document.getElementById(`prompt_comment_input_${promptId}`);
            const text = input.value.trim();
            if(!text) return;
            
            const newComment = { 
                author: currentUser.name, 
                content: text, 
                timestamp: Date.now() 
            };
            
            db.collection('prompts').doc(promptId).update({
                comments: firebase.firestore.FieldValue.arrayUnion(newComment)
            }).then(() => {
                loadData();
            }).catch(e => {
                console.error("Comment submission failed, trying to set.", e);
                db.collection('prompts').doc(promptId).set({ comments: [newComment] }, { merge: true }).then(() => loadData());
            });
        }

        function showPage(pageId) { 
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
            document.getElementById(pageId).classList.add('active'); 
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            const activeMenuId = 'menu-' + pageId;
            const activeItem = document.getElementById(activeMenuId);
            if(activeItem) activeItem.classList.add('active');
            if(window.innerWidth<=768 && document.querySelector('.sidebar').classList.contains('active')) {
                toggleSidebar();
            }
            window.scrollTo(0, 0);
        }

        function filterApps(type) { document.querySelectorAll('#appsContainer .card').forEach(c => { c.style.display = 'none'; const cat=c.getAttribute('data-cat'), sub=c.getAttribute('data-sub'); if(type==='all' || (type==='value'&&sub==='åƒ¹å€¼è§€æ•™è‚²') || (type ==='teaching' && cat==='teaching') || (type==='admin' && cat==='admin') ) c.style.display='flex'; }); }
        
        function handleCategoryChange() { 
            const cat = document.getElementById('appCategory').value; 
            const isAdmin = (cat === 'admin');
            
            document.getElementById('subjectGroup').style.display = isAdmin ? 'none' : 'block';
            document.getElementById('adminTypeGroup').style.display = isAdmin ? 'block' : 'none'; 
            
            const tagsContainer = document.getElementById('tagsCheckboxContainer');
            if (isAdmin) {
                tagsContainer.style.opacity = '0.4';
                tagsContainer.style.pointerEvents = 'none';
                tagsContainer.style.filter = 'grayscale(100%)';
                tagsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            } else {
                tagsContainer.style.opacity = '1';
                tagsContainer.style.pointerEvents = 'auto';
                tagsContainer.style.filter = 'none';
            }
        }
        
        function handleSubjectChange() { const sub = document.getElementById('appSubject').value; document.getElementById('crossSubjectSection').style.display = sub === 'è·¨èª²ç¨‹' ? 'block' : 'none'; }
        function submitComment(appId) { const input = document.getElementById(`comment_input_${appId}`); const text = input.value.trim(); if(!text) return; const newComment = { author: currentUser.name, content: text, timestamp: Date.now() }; db.collection('apps').doc(appId).update({ comments: firebase.firestore.FieldValue.arrayUnion(newComment) }).then(() => loadData()).catch(e => { db.collection('apps').doc(appId).set({ comments: [newComment] }, { merge: true }).then(() => loadData()); }); }
        function submitRating(appId) { const ease = document.getElementById(`ease_${appId}`).value, effect = document.getElementById(`effect_${appId}`).value; const data = {}; data[`ratings.${currentUser.uid}`] = { ease: parseInt(ease), effect: parseInt(effect) }; db.collection('apps').doc(appId).update(data).then(() => { alert("è©•åˆ†æˆåŠŸï¼"); loadData(); }).catch(e => { db.collection('apps').doc(appId).set({ ratings: { [currentUser.uid]: { ease: parseInt(ease), effect: parseInt(effect) } } }, { merge: true }).then(() => { alert("è©•åˆ†æˆåŠŸï¼"); loadData(); }); }); }
        
        function triggerAutoTag() {
            if (document.getElementById('appCategory').value === 'admin') return;
            const prompt = document.getElementById('appPrompt').value; 
            const title = document.getElementById('appTitle').value; 
            const combined = prompt + title;
            if(combined.includes("ç•«") || combined.includes("å‰µ") || combined.includes("Design")) checkTag("Creativity");
            if(combined.includes("å•") || combined.includes("æ€") || combined.includes("Think")) checkTag("Critical Thinking");
            if(combined.includes("çµ„") || combined.includes("åˆ") || combined.includes("Group")) checkTag("Collaboration");
            if(combined.includes("èªª") || combined.includes("è©±") || combined.includes("Speak")) checkTag("Communication");
            if(combined.includes("å¹«") || combined.includes("äº«") || combined.includes("Share")) checkTag("Contribution");
            if(combined.includes("AI")) checkTag("AI ç”Ÿæˆ");
            if(combined.includes("è©•ä¼°") || combined.includes("æ¸¬é©—")) checkTag("è©•ä¼°å·¥å…·");
        }
        
        function checkTag(val) { const cb = document.querySelector(`input[name="appTag"][value="${val}"]`); if(cb) cb.checked = true; }

        function toggleUploadForm() { const type = document.getElementById('uploadType').value; document.getElementById('appForm').style.display = type === 'app' ? 'block' : 'none'; document.getElementById('promptForm').style.display = type === 'prompt' ? 'block' : 'none'; resetForm(false); }
        
        function submitUpload() {
            const isEdit = document.getElementById('editModeId').value !== "";
            const collection = document.getElementById('uploadType').value === 'app' ? 'apps' : 'prompts';
            const data = { title: document.getElementById(collection === 'apps' ? 'appTitle' : 'promptTitle').value, author: currentUser.name, authorEmail: currentUser.email, timestamp: Date.now() };
            if(collection === 'apps') {
                let crossSubs = [];
                if(document.getElementById('appSubject').value === 'è·¨èª²ç¨‹') { document.querySelectorAll('input[name="crossSub"]:checked').forEach(cb => { if(cb.value) crossSubs.push(cb.value); }); }
                
                let selectedTags = [];
                if (document.getElementById('appCategory').value !== 'admin') {
                    document.querySelectorAll('input[name="appTag"]:checked').forEach(cb => selectedTags.push(cb.value));
                }

                const rType = document.getElementById('resourceType').value;
                let finalLink = document.getElementById('appLink').value;
                if(rType === 'image' && document.getElementById('appFileBase64').value) { finalLink = document.getElementById('appFileBase64').value; }
                
                Object.assign(data, {
                    category: document.getElementById('appCategory').value, subject: document.getElementById('appSubject').value, crossSubjects: crossSubs,
                    adminType: document.getElementById('appAdminType').value, resourceType: rType, link: finalLink,
                    painPoint: document.getElementById('appPainPoint').value, promptText: document.getElementById('appPrompt').value,
                    remarks: document.getElementById('appRemarks').value,
                    tags: selectedTags
                });
                if(!isEdit) { data.ratings = {}; data.comments = []; }
            } else { 
                Object.assign(data, { content: document.getElementById('promptContent').value, purpose: document.getElementById('promptPurpose').value }); 
                if(!isEdit) { data.likes = []; data.comments = []; }
            }
            const action = isEdit ? db.collection(collection).doc(document.getElementById('editModeId').value).update(data) : db.collection(collection).add(data);
            action.then(() => { alert(isEdit ? "æ›´æ–°æˆåŠŸ" : "ç™¼å¸ƒæˆåŠŸ"); resetForm(true); loadData(); }).catch(e => alert("éŒ¯èª¤: " + e.message));
        }
        
        function deleteResource() {
            const docId = document.getElementById('editModeId').value; if(!docId) return;
            if(confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤é€™å€‹è³‡æºå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•é‚„åŸã€‚")) { const collection = document.getElementById('uploadType').value === 'app' ? 'apps' : 'prompts'; db.collection(collection).doc(docId).delete().then(() => { alert("å·²åˆªé™¤"); resetForm(true); loadData(); }); }
        }
        
        function editApp(app) {
            showPage('upload'); document.getElementById('editModeId').value = app.id; document.getElementById('uploadType').value = 'app'; toggleUploadForm();
            document.getElementById('appTitle').value = app.title; document.getElementById('appCategory').value = app.category; 
            handleCategoryChange();
            document.getElementById('appSubject').value = app.subject || ""; handleSubjectChange(); 
            document.querySelectorAll('input[name="crossSub"]').forEach(cb => cb.checked = false);
            if (app.subject === 'è·¨èª²ç¨‹' && app.crossSubjects && Array.isArray(app.crossSubjects)) {
                document.getElementById('crossSubjectSection').style.display = 'block';
                app.crossSubjects.forEach(sub => { const cb = document.querySelector(`input[name="crossSub"][value="${sub.trim()}"]`); if(cb) cb.checked = true; });
            }
            document.getElementById('appAdminType').value = app.adminType || "";
            document.getElementById('resourceType').value = app.resourceType || 'url'; handleResourceTypeChange();
            if(app.resourceType === 'image' && app.link.startsWith('data:')) { document.getElementById('imagePreview').src = app.link; document.getElementById('imagePreviewBox').style.display = 'block'; document.getElementById('appFileBase64').value = app.link; } else { document.getElementById('appLink').value = app.link; }
            document.getElementById('appPainPoint').value = app.painPoint; document.getElementById('appPrompt').value = app.promptText || ""; 
            document.getElementById('appRemarks').value = app.remarks || "";
            document.querySelectorAll('input[name="appTag"]').forEach(cb => cb.checked = false); 
            if(app.category !== 'admin' && app.tags && Array.isArray(app.tags)) {
                app.tags.forEach(tag => { const cb = document.querySelector(`input[name="appTag"][value="${tag}"]`); if(cb) cb.checked = true; });
            }
            const btn = document.getElementById('submitBtn'); btn.innerText = "ç¢ºèªæ›´æ–°"; btn.classList.replace('btn-primary', 'btn-success'); document.getElementById('cancelBtn').style.display = 'block'; document.getElementById('deleteBtn').style.display = 'block'; 
        }
        
        function editPrompt(p) {
            showPage('upload'); document.getElementById('editModeId').value = p.id; document.getElementById('uploadType').value = 'prompt'; toggleUploadForm();
            document.getElementById('promptTitle').value = p.title; document.getElementById('promptContent').value = p.content; document.getElementById('promptPurpose').value = p.purpose;
            const btn = document.getElementById('submitBtn'); btn.innerText = "ç¢ºèªæ›´æ–°"; btn.classList.replace('btn-primary', 'btn-success'); document.getElementById('cancelBtn').style.display = 'block'; document.getElementById('deleteBtn').style.display = 'block';
        }
        
        function resetForm(shouldRedirect = false) {
            document.getElementById('editModeId').value = ""; document.querySelectorAll('input[type="text"], input[type="file"], input[type="hidden"], textarea').forEach(i => i.value = ""); 
            document.getElementById('appCategory').value = 'teaching'; handleCategoryChange();
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('crossSubjectSection').style.display = 'none';
            document.getElementById('imagePreviewBox').style.display = 'none'; document.getElementById('imagePreview').src = ""; document.getElementById('appFile').value = "";
            document.getElementById('resourceType').value = "url"; handleResourceTypeChange();
            const btn = document.getElementById('submitBtn'); btn.innerText = "ç¢ºèªç™¼å¸ƒ"; btn.classList.replace('btn-success', 'btn-primary'); document.getElementById('cancelBtn').style.display = 'none'; document.getElementById('deleteBtn').style.display = 'none';
            if (shouldRedirect) { const currentType = document.getElementById('uploadType').value; showPage(currentType === 'app' ? 'apps' : 'prompts'); }
        }
        
        function exportDataReport() {
            db.collection('apps').get().then(snap => {
                let csv = "data:text/csv;charset=utf-8,\uFEFFID,Title,Category,Subject/Type,ResourceType,Author,PainPoint,Remarks\n";
                snap.forEach(doc => { const d = doc.data(); const sub = d.category==='teaching' ? d.subject : d.adminType; const rType = d.resourceType || 'url'; const remarks = d.remarks ? `"${d.remarks.replace(/"/g, '""')}"` : ""; const title = `"${d.title.replace(/"/g, '""')}"`; const pp = `"${d.painPoint.replace(/"/g, '""')}"`; csv += `${doc.id},${title},${d.category},${sub},${rType},${d.author},${pp},${remarks}\n`; });
                const link = document.createElement("a"); link.setAttribute("href", encodeURI(csv)); link.setAttribute("download", "BCK_AI_Hub_Apps_Report.csv"); document.body.appendChild(link); link.click();
            });
        }
    </script>
</body>
</html>
